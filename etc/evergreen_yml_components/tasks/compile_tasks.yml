# This file contains compile and related tasks

################################################
#                   Variable                   #
################################################
variables:
  - &compile_bazel_task_group_template
    name: compile_bazel_task_group_template
    max_hosts: -1
    tasks: []
    setup_group_can_fail_task: true
    setup_group:
      - command: manifest.load
      - func: "git get project and add git tag"
      - func: "set task expansion macros"
      - func: "f_expansions_write"
      - func: "set up venv"
      - func: "upload pip requirements"
      - func: "configure evergreen api credentials"
      - func: "get buildnumber"
      - func: "f_expansions_write"
      - func: "set up credentials"
      - func: "f_expansions_write"
      - func: "get engflow creds"

  # THIS HAS COPIES IN
  # - etc/evergreen_yml_components/tasks/resmoke/server_divisions/clusters_and_integrations/tasks.yml
  # - etc/evergreen_yml_components/tasks/compile_tasks.yml
  # - etc/evergreen_yml_components/tasks/compile_tasks_shared.yml
  # ANY MODIFICATIONS HERE SHOULD ALSO BE MADE IN THOSE FILES
  - &compile_task_group_template
    name: compile_task_group_template
    max_hosts: 1
    tasks: []
    setup_task:
      - func: "f_expansions_write"
      - func: "apply compile expansions"
      - func: "f_expansions_write"
      - func: "set task expansion macros"
      - func: "f_expansions_write"
      - func: "get engflow creds"
      - func: "fetch pgo profile"
    teardown_task:
      - func: "f_expansions_write"
      - func: "attach scons logs"
      - func: "attach report"
      - func: "attach artifacts"
      - func: "attach local resmoke invocation"
      - func: "attach multiversion download links"
      - func: "kill processes"
      - func: "save code coverage data"
      - func: "save mongo coredumps"
      - func: "generate hang analyzer tasks"
      - func: "save failed unittests"
      - func: "save unstripped dbtest"
      - func: "save bazel headers"
      - func: "save bazel jvm dump"
      - func: "save hang analyzer debugger files"
      - func: "save disk statistics"
      - func: "save system resource information"
      - func: "save libfuzzertest corpora"
      - func: "remove files"
        vars:
          files: >-
            src/resmoke_error_code
            src/build/scons/config.log
            src/*.gcda.gcov
            src/gcov-intermediate-files.tgz
            src/*.core src/*.mdmp src/*.core.gz src/*.mdmp.gz
            mongo-coredumps.json
            src/dist-unittests/bin/*
            src/dist-unittests/lib/*
            mongo-unittests.tgz
            src/debugger*.*
            src/mongo-hanganalyzer.tgz
            diskstats.tgz
            system-resource-info.tgz
            ${report_file|src/report.json}
            ${archive_file|src/archive.json}
    setup_group_can_fail_task: true
    setup_group:
      - command: manifest.load
      - func: "git get project and add git tag"
      - func: "set task expansion macros"
      - func: "f_expansions_write"
      - func: "kill processes"
      - func: "cleanup environment"
      # The python virtual environment is installed in ${workdir}, which is created in
      # "set up venv".
      - func: "set up venv"
      - func: "upload pip requirements"
      - func: "f_expansions_write"
      - func: "configure evergreen api credentials"
      - func: "get buildnumber"
      - func: "f_expansions_write"
      - func: "set up credentials"
      - func: "f_expansions_write"
      - func: "use WiredTiger develop" # noop if ${use_wt_develop} is not "true"
      - func: "f_expansions_write"
      - func: "set up win mount script"
      - func: "f_expansions_write"
      - func: "generate compile expansions"
      - func: "f_expansions_write"
    teardown_group:
      - func: "f_expansions_write"
      - func: "umount shared scons directory"
      - func: "cleanup environment"
    timeout:
      - func: "f_expansions_write"
      - func: "run hang analyzer"
      - func: "wait for resmoke to shutdown"

  - &clang_tidy_scons_compile_vars
    task_compile_flags: >-
      --build-profile=compiledb
    targets: compiledb +mongo-tidy-tests
    compiling_for_test: true
    compile_flags: >-
      --link-model=dynamic
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_v4_clang.vars
    show_scons_timings: false

  - &clang_tidy_task_template
    tags:
      [
        "assigned_to_jira_team_devprod_build",
        "development_critical_single_variant",
        "requires_large_host",
        "clang_tidy",
      ]
    exec_timeout_secs: 7200 # 1 hour timeout for the task overall
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version

  # TODO: split this up into the user files.
  # List of all variants that make mongocryptd
  # If a variant is listed here and has a push task, mongocryptd is pushed
  - mongocryptd_variants: &mongocryptd_variants
      - enterprise-amazon2023
      # TODO(SERVER-85904) - enterprise-amazon2023-lto
      - enterprise-amazon2023-arm64
      # TODO(SERVER-85904) - enterprise-amazon2023-arm64-lto
      - enterprise-debian12-64
      - enterprise-linux-64-amazon-ami
      - enterprise-macos
      - enterprise-macos-arm64
      - enterprise-rhel-81-ppc64le
      - enterprise-rhel-8-64-bit
      - enterprise-rhel-8-64-bit-coverage
      - enterprise-rhel-8-64-bit-suggested
      - enterprise-rhel-8-arm64
      - enterprise-rhel-83-s390x
      - enterprise-rhel-90-64-bit
      - enterprise-rhel-90-arm64
      - enterprise-rhel-93-64-bit
      - enterprise-rhel-93-arm64
      - enterprise-suse15-64
      - enterprise-ubuntu2004-arm64
      - enterprise-ubuntu2204-arm64
      - enterprise-ubuntu2004-64
      - enterprise-ubuntu2204-64
      - enterprise-windows
      - enterprise-windows-debug-unoptimized
      - enterprise-windows-inmem
      - enterprise-windows-wtdevelop

################################################
#                    Tasks                     #
################################################
tasks:
  ## compile - build bazel targets ##
  ## The bazel migration is in progress & this
  ## task ensures we can build with bazel.
  - name: bazel_workstation_unittests
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "get engflow creds"
      - func: "scons compile"
        vars:
          targets: >-
            install-all
            archive-all
          bazel_build_tags: --bazel-build-tag=all
          task_compile_flags: >-
            ICECC=
            CCACHE=
            --build-profile=opt
            --ninja=disabled
            --keep-going
      - command: s3.put
        params:
          optional: true
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/all-runtime.tgz
          remote_file: ${all_mongo_binaries}
          bucket: mciuploads
          permissions: public-read
          content_type: application/gzip
          display_name: Binaries
      - func: "scons compile"
        vars:
          targets: >-
            prove-unittests
          task_compile_flags: >-
            ICECC=
            CCACHE=
            --build-profile=opt
            --ninja=disabled
            --keep-going

  # TODO(SERVER-82195): simplify this to avoid duplication of parameters in other tests.
  - name: compile_dist_test_quick
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          targets: >-
            build/opt/mongo/db/commands/libfsync_locked.a
            build/opt/mongo/db/commands/libtest_commands_enabled.a
          task_compile_flags: >-
            ICECC=
            --build-profile=opt
            --ninja=disabled
            --link-model=static
            --modules=
      - func: "verify build output present"
        vars:
          output: build/opt/mongo/db/commands/libfsync_locked.a

  - name: run_bazel_program
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "fetch bazel"
      - func: "bazel run"
        vars:
          target: >-
            //src/mongo/platform:visibility1_test

  - <<: *clang_tidy_task_template
    name: run_bazel_clang_tidy
    commands:
      - func: "do scons setup"
      - func: "fetch bazel"
      - func: "bazel compile (clang)"
        vars:
          compiler: clang
          # Note that we only run clang-tidy on the Mongo-authored targets, not on third-party code.
          targets: //src/mongo/...
          args: --config=clang-tidy

  - name: run_bazel_program_windows
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "fetch bazel"
      - func: "bazel run"
        vars:
          target: >-
            //src/mongo/platform:visibility1_test
          # TODO DEVPROD-2508 remove dbg flags when compilation_mode is synced with build_mode automatically
          args: >-
            --compilation_mode=dbg

  ## compile - build all scons targets except unittests ##
  - name: compile_dist_test_half
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          targets: >-
            compile_first_half_non_test_source
            ${additional_compile_targets|}
          task_compile_flags: >-
            PREFIX=dist-test

  - name: compile_upload_benchmarks
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          targets: >-
            install-benchmarks
            archive-benchmarks
          bazel_build_tags: --bazel-build-tag=mongo_benchmark --bazel-build-tag=mongo_library --bazel-build-tag=-repl_bm
          compiling_for_test: true
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/benchmarks.${ext|tgz}
          remote_file: ${mongo_benchmarks}
          bucket: mciuploads
          permissions: public-read
          content_type: application/tar
          display_name: Benchmarks

  - name: compile_upload_benchmarks_debug
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    # TODO(SERVER-86426): Figure out a workable long-term solution to benchmark debug symbols
    disable: true
    depends_on:
      - name: compile_upload_benchmarks
    commands:
      - func: "scons compile"
        vars:
          targets: >-
            install-benchmarks-debug
            archive-benchmarks-debug
          compiling_for_test: true
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/benchmarks-debugsymbols.${ext|tgz}
          remote_file: ${mongo_benchmarks_debugsymbols}
          bucket: mciuploads
          permissions: public-read
          content_type: application/tar
          display_name: Benchmarks Debug

  - name: compile_ninja
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --ninja
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "build.ninja"
          targets: "install-devcore compiledb"

  - name: compile_ninja_quick
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --ninja
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "build.ninja"
          targets: "install-wiredtiger compiledb"

  - name: compile_ninja_default_profile
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=default
            --ninja
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "build.ninja"

  - name: compile_ninja_default_profile_linux
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=default
            --variables-files=etc/scons/mongodbtoolchain_stable_clang.vars
            --ninja
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "build.ninja"
          targets: "install-devcore compiledb"

  - name: compile_ninja_opt_profile
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=opt
            CCACHE=
            ICECC=
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "opt.ninja"
          targets: "install-devcore compiledb"

  - name: compile_ninja_bazel
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=fast
            CCACHE=
            ICECC=
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "fast.ninja"
          targets: "install-wiredtiger compiledb"

  - name: compile_ninja_fast_profile
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=fast
            CCACHE=
            ICECC=
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "fast.ninja"
          targets: "install-devcore compiledb"

  - name: compile_ninja_fast_icecc
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=fast
            BAZEL_INTEGRATION_DEBUG=1
            CCACHE=
            ICECC=icecc
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "fast.ninja"
          targets: "install-devcore compiledb"

  - name: compile_ninja_san_profile
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=san
            --linker=lld
            CCACHE=
            ICECC=
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "san.ninja"
          targets: "install-devcore compiledb"

  - name: compile_ninja_compiledb_profile
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-profile=compiledb
            --ninja
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "compiledb.ninja"
          targets: "install-devcore compiledb"

  - name: compile_ninja_next
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          generating_for_ninja: true
          separate_debug: off
          task_compile_flags: >-
            --build-tools=next
            --ninja
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "build.ninja"
          targets: "install-devcore compiledb"

  - name: libdeps_graph_linting
    tags:
      [
        "assigned_to_jira_team_devprod_build",
        "development_critical_single_variant",
      ]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "do scons setup"
      - func: "f_expansions_write"

      - func: "scons compile"
        vars:
          task_compile_flags: >-
            --link-model=dynamic
            --force-macos-dynamic-link
            --build-tools=next
          targets: generate-libdeps-graph
          bazel_build_tags: --bazel-build-tag=all
      - command: subprocess.exec
        params:
          binary: bash
          args:
            - "src/evergreen/libdeps_setup.sh"

      - command: subprocess.exec
        params:
          binary: bash
          args:
            - "src/evergreen/libdeps_run.sh"

      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/results.txt
          remote_file: ${project}/${build_variant}/${revision}/artifacts/libdeps-results.txt.${build_id}-${task_name}.${execution}
          bucket: mciuploads
          permissions: public-read
          content_type: text/plain
          display_name: Libdeps Linter Results

      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/bazel_order.txt
          remote_file: ${project}/${build_variant}/${revision}/artifacts/bazel_order.txt.${build_id}-${task_name}.${execution}
          bucket: mciuploads
          permissions: public-read
          content_type: text/plain
          display_name: Bazel Target Conversions

      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/libdeps.graphml.gz
          remote_file: ${project}/${build_variant}/${revision}/artifacts/libdeps.graphml.${build_id}-${task_name}.${execution}.gz
          bucket: mciuploads
          permissions: public-read
          content_type: ${content_type|application/gzip}
          display_name: Libdeps Graph Data

  ## compile_all - build all scons targets ##
  - name: compile_all_future_git_tag_multiversion
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: compile_dist_test_future_git_tag_multiversion
    commands:
      - func: "scons compile"
        vars:
          targets: install-all-meta
          bazel_build_tags: --bazel-build-tag=all
          compiling_for_test: true

  - name: compile_all_but_not_unittests
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: compile_dist_test
    commands:
      - func: "scons compile"
        vars:
          targets: install-all-meta-but-not-unittests
          compiling_for_test: true
          # The executables generated by the install-all target are not used after successfully being
          # compiled. We therefore compile them without debug symbols to compile them faster.
          task_compile_flags: >-
            --debug-symbols=off
          bazel_build_tags: --bazel-build-tag=-mongo_unittest --bazel-build-tag=mongo_binary --bazel-build-tag=mongo_benchmark --bazel-build-tag=mongo_integration_test --bazel-build-tag=mongo_library

  - <<: *clang_tidy_task_template
    name: clang_tidy_1
    commands:
      - func: "do scons setup"
      - func: "scons compile"
        vars:
          <<: *clang_tidy_scons_compile_vars
      - func: "run clang tidy"
        vars:
          split: 1

  - <<: *clang_tidy_task_template
    name: clang_tidy_2
    commands:
      - func: "do scons setup"
      - func: "scons compile"
        vars:
          <<: *clang_tidy_scons_compile_vars
      - func: "run clang tidy"
        vars:
          split: 2

  - <<: *clang_tidy_task_template
    name: clang_tidy_3
    commands:
      - func: "do scons setup"
      - func: "scons compile"
        vars:
          <<: *clang_tidy_scons_compile_vars
      - func: "run clang tidy"
        vars:
          split: 3

  - <<: *clang_tidy_task_template
    name: clang_tidy_4
    commands:
      - func: "do scons setup"
      - func: "scons compile"
        vars:
          <<: *clang_tidy_scons_compile_vars
      - func: "run clang tidy"
        vars:
          split: 4

  ## compile_unittests ##
  - name: compile_unittests_future_git_tag_multiversion
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: compile_dist_test_future_git_tag_multiversion
    commands:
      - func: "scons compile"
        vars:
          targets: install-unittests install-unittests-debug
          bazel_build_tags: --bazel-build-tag=mongo_unittest --bazel-build-tag=mongo_binary_unittest
          compiling_for_test: true

  - name: compile_libraries_for_unittests
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    exec_timeout_secs: 32400 # 9 hours
    commands:
      - func: "scons compile"
        vars:
          # Target the conf to just run the bazel part of the build
          targets: \$BUILD_ROOT/scons/\$VARIANT_DIR/sconf_temp
          compiling_for_test: true
          task_compile_flags: ${unittest_compile_flags}
          bazel_build_tags: --bazel-build-tag=mongo_library

  - name: compile_and_run_unittests_first_quarter
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
      - name: compile_libraries_for_unittests
    exec_timeout_secs: 32400 # 9 hours
    commands:
      - func: "scons compile"
        vars:
          targets: install-first-quarter-unittests install-first-quarter-unittests-debug
          compiling_for_test: true
          task_compile_flags: ${unittest_compile_flags}
          bazel_build_tags: --bazel-build-tag=mongo_unittest_first_group --bazel-build-tag=mongo_binary_unittest --bazel-build-tag=mongo_library
      - func: "f_expansions_write"
      - func: "run diskstats"
      - func: "f_expansions_write"
      - func: "monitor process threads"
      - func: "collect system resource info"
      - func: "run tests"
        vars:
          suite: unittests_first_quarter
          install_dir: build/install/bin
          exec_timeout_secs: 32400 # 9 hours

  - name: compile_and_run_unittests_second_quarter
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
      - name: compile_libraries_for_unittests
    exec_timeout_secs: 32400 # 9 hours
    commands:
      - func: "scons compile"
        vars:
          targets: install-second-quarter-unittests install-second-quarter-unittests-debug
          compiling_for_test: true
          task_compile_flags: ${unittest_compile_flags}
          bazel_build_tags: --bazel-build-tag=mongo_unittest_second_group --bazel-build-tag=mongo_binary_unittest --bazel-build-tag=stitch_support_test --bazel-build-tag=mongo_library
      - func: "f_expansions_write"
      - func: "run diskstats"
      - func: "f_expansions_write"
      - func: "monitor process threads"
      - func: "collect system resource info"
      - func: "run tests"
        vars:
          suite: unittests_second_quarter
          install_dir: build/install/bin
          exec_timeout_secs: 32400 # 9 hours

  - name: compile_and_run_unittests_third_quarter
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
      - name: compile_libraries_for_unittests
    exec_timeout_secs: 32400 # 9 hours
    commands:
      - func: "scons compile"
        vars:
          targets: install-third-quarter-unittests install-third-quarter-unittests-debug
          compiling_for_test: true
          task_compile_flags: ${unittest_compile_flags}
          bazel_build_tags: --bazel-build-tag=mongo_unittest_third_group --bazel-build-tag=mongo_binary_unittest --bazel-build-tag=mongo_library
      - func: "f_expansions_write"
      - func: "run diskstats"
      - func: "f_expansions_write"
      - func: "monitor process threads"
      - func: "collect system resource info"
      - func: "run tests"
        vars:
          suite: unittests_third_quarter
          install_dir: build/install/bin
          exec_timeout_secs: 32400 # 9 hours

  - name: compile_and_run_unittests_fourth_quarter
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
      - name: compile_libraries_for_unittests
    exec_timeout_secs: 32400 # 9 hours
    commands:
      - func: "scons compile"
        vars:
          targets: install-fourth-quarter-unittests install-fourth-quarter-unittests-debug
          compiling_for_test: true
          task_compile_flags: ${unittest_compile_flags}
          bazel_build_tags: --bazel-build-tag=mongo_unittest_fourth_group --bazel-build-tag=mongo_binary_unittest --bazel-build-tag=mongo_library
      - func: "f_expansions_write"
      - func: "run diskstats"
      - func: "f_expansions_write"
      - func: "monitor process threads"
      - func: "collect system resource info"
      - func: "run tests"
        vars:
          suite: unittests_fourth_quarter
          install_dir: build/install/bin
          exec_timeout_secs: 32400 # 9 hours

  ## run_unittests ##
  - name: run_unittests_future_git_tag_multiversion
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: compile_unittests_future_git_tag_multiversion
    commands:
      - func: "f_expansions_write"
      - func: "run diskstats"
      - func: "f_expansions_write"
      - func: "monitor process threads"
      - func: "collect system resource info"
      - func: "run tests"
        vars:
          suite: unittests
          install_dir: build/install/bin

  ##compile_and_archive_libfuzzertests - build libfuzzertests ##
  - name: compile_and_archive_libfuzzertests
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "scons compile"
        vars:
          targets: archive-fuzzertests
          compiling_for_test: true
      # Store the fuzzer executable, which we use to generate and run fuzzer inputs.
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: "src/fuzzertests-runtime.tgz"
          remote_file: "${project}/libfuzzer-tests/${build_variant}/${revision}/libfuzzer-tests.tgz"
          bucket: mciuploads
          permissions: private
          visibility: signed
          content_type: application/tar
          display_name: "LibFuzzer Tests"

  ## compile_dbtest ##
  - &compile_dbtest
    name: compile_dbtest
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: compile_dist_test
    commands:
      - func: "scons compile"
        vars:
          targets: install-dbtest install-dbtest-debug
          compiling_for_test: true

  - <<: *compile_dbtest
    name: compile_dbtest_future_git_tag_multiversion
    depends_on:
      - name: compile_dist_test_future_git_tag_multiversion

  ## run_dbtest ##
  - &run_dbtest
    name: run_dbtest
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: compile_dbtest
    commands:
      - func: "f_expansions_write"
      - func: "run diskstats"
      - func: "f_expansions_write"
      - func: "monitor process threads"
      - func: "collect system resource info"
      - func: "run tests"
        vars:
          suite: dbtest
          install_dir: build/install/bin

  - <<: *run_dbtest
    name: run_dbtest_future_git_tag_multiversion
    depends_on:
      - name: compile_dbtest_future_git_tag_multiversion

  - &archive_dbtest
    name: archive_dbtest
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary", "bazel_check"]
    depends_on:
      - name: compile_dbtest
    commands:
      - func: "scons compile"
        vars:
          targets: archive-dbtest archive-dbtest-debug
          compiling_for_test: true

  - <<: *archive_dbtest
    name: archive_dbtest_future_git_tag_multiversion
    depends_on:
      - name: compile_dbtest_future_git_tag_multiversion

  - name: compile_integration_test
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: compile_dist_test
    commands:
      - func: "scons compile"
        vars:
          targets: install-integration-tests
          bazel_build_tags: --bazel-build-tag=mongo_integration_test --bazel-build-tag=dist_test --bazel-build-tag=mongo_library
          compiling_for_test: true

  - name: archive_jstestshell
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "activate task"
        vars:
          task_to_activate: archive_jstestshell_debug
      - func: "scons compile"
        vars: &archive_jstestshell_vars
          targets: archive-jstestshell
          compiling_for_test: true
          separate_debug: on
          bazel_build_tags: --bazel-build-tag=jstestshell
          task_compile_flags: >-
            PREFIX=dist-test
            --link-model=static
            --dbg=on
            --opt=on
            --sanitize=
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/mongodb-jstestshell.${ext|tgz}
          remote_file: ${mongo_jstestshell}
          bucket: mciuploads
          permissions: public-read
          content_type: ${content_type|application/gzip}
          display_name: Jstestshell

  - name: archive_jstestshell_debug
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: archive_jstestshell
    commands:
      - func: "f_expansions_write"
      - func: "scons compile"
        vars:
          <<: *archive_jstestshell_vars
          targets: archive-jstestshell-debug
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/mongodb-jstestshell-debugsymbols.${ext|tgz}
          remote_file: ${mongo_jstestshell_debugsymbols}
          bucket: mciuploads
          permissions: public-read
          content_type: ${content_type|application/gzip}
          display_name: Jstestshell Debugsymbols

  - name: stitch_support_create_lib
    tags:
      [
        "assigned_to_jira_team_devprod_build",
        "release_critical",
        "requires_compile_variant",
        "requires_large_host",
        "stitch",
        "bazel_check",
      ]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "do scons setup"
      - func: "f_expansions_write"
      - func: "scons compile"
        vars:
          targets: install-stitch-support install-stitch-support-debug install-stitch-support-dev
          bazel_build_tags: --bazel-build-tag=stitch_support
          task_compile_flags: >-
            --link-model=dynamic-sdk
            --ssl=off
            --enable-http-client=off
            --modules=
            DESTDIR='$BUILD_ROOT/stitch-support-lib-$MONGO_VERSION'
      - func: "f_expansions_write"
      - command: subprocess.exec
        params:
          binary: bash
          args:
            - "src/evergreen/stitch_support_create_lib_tar.sh"
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: "src/build/stitch-support.tgz"
          remote_file: "${project}/stitch-support/${build_variant}/${revision}/stitch-support-${version}.tgz"
          bucket: mciuploads
          permissions: public-read
          content_type: application/tar
          display_name: "Stitch Support Library"

  - name: stitch_support_install_and_run_tests
    tags:
      [
        "assigned_to_jira_team_devprod_build",
        "release_critical",
        "incompatible_mac",
        "requires_compile_variant",
        "requires_large_host",
        "stitch",
        "bazel_check",
      ]
    depends_on:
      - name: stitch_support_create_lib
    commands:
      - func: "do scons setup"
      - func: "f_expansions_write"
      - func: "scons compile"
        vars:
          targets: install-stitch-support-test
          bazel_build_tags: --bazel-build-tag=stitch_support_test
          compiling_for_test: true
          task_compile_flags: >-
            --ssl=off
            --enable-http-client=off
            --modules=
            DESTDIR='$BUILD_ROOT/stitch-support-lib-$MONGO_VERSION'
      - func: "get and apply version expansions"
      - func: "f_expansions_write"
      - command: subprocess.exec
        type: test
        params:
          binary: bash
          args:
            - "src/evergreen/stitch_support_run_tests.sh"

  - name: crypt_create_debug_lib
    tags: ["assigned_to_jira_team_server_security", "auxiliary", "bazel_check"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "f_expansions_write"
      - func: "scons compile"
        vars:
          targets: archive-mongo-crypt-dev archive-mongo-crypt-debug
          bazel_build_tags: --bazel-build-tag=mongo_library
          task_compile_flags: >-
            --dbg=on
            --opt=off
            --allocator=system
            --enterprise-features=fle
            --js-engine=none
            --link-model=dynamic-sdk
            DESTDIR='$BUILD_ROOT/crypt-lib-$MONGO_VERSION'
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: "src/mongo-crypt-dev.${ext|tgz}"
          remote_file: "${project}/mongo_crypt/${build_variant}/${revision}/mongo_crypt_shared_v1_dev-${version}.${ext|tgz}"
          bucket: mciuploads
          permissions: public-read
          content_type: ${content_type|application/tar}
          display_name: "Mongo Crypt Library dev"
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: "src/mongo-crypt-debug.${ext|tgz}"
          remote_file: "${project}/mongo_crypt/${build_variant}/${revision}/mongo_crypt_shared_v1_debug-${version}.${ext|tgz}"
          bucket: mciuploads
          permissions: public-read
          content_type: ${content_type|application/tar}
          display_name: "Mongo Crypt Library debug"

  - name: crypt_install_tests
    tags: ["assigned_to_jira_team_server_security", "auxiliary", "bazel_check"]
    depends_on:
      - name: crypt_create_debug_lib
    commands:
      - func: "f_expansions_write"
      - func: "scons compile"
        vars:
          targets: archive-mongo-crypt-shlib-test
          compiling_for_test: true
          task_compile_flags: >-
            --allocator=system
            --enterprise-features=fle
            --js-engine=none
            --link-model=static
            DESTDIR='$BUILD_ROOT/crypt-lib-$MONGO_VERSION'
            RPATH='$$RPATH_ESCAPED_DOLLAR_ORIGIN/../lib'
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: "src/mongo-crypt-shlib-test-runtime.${ext|tgz}"
          remote_file: "${project}/mongo_crypt/${build_variant}/${revision}/mongo_crypt_shlib_test-${version}.${ext|tgz}"
          bucket: mciuploads
          permissions: public-read
          content_type: ${content_type|application/tar}
          display_name: "Mongo Crypt Shared Library Test"

  - name: crypt_run_tests
    tags: ["assigned_to_jira_team_server_security", "auxiliary", "bazel_check"]
    depends_on:
      - name: crypt_install_tests
    commands:
      - func: "get and apply version expansions"
      - func: "f_expansions_write"
      - command: subprocess.exec
        type: test
        params:
          binary: bash
          args:
            - "src/evergreen/crypt_run_tests.sh"

  - name: publish_packages
    run_on: rhel8.7-small
    tags:
      [
        "assigned_to_jira_team_devprod_build",
        "release_critical",
        "incompatible_development_variant",
        "requires_compile_variant",
        "publish",
      ]
    # This should prevent this task from running in patch builds, where we
    # don't want to publish packages.
    patchable: false
    stepback: false
    # Same dependencies as "push" below
    depends_on:
      - name: package
      - name: jsCore
      - name: run_dbtest
      - name: replica_sets_jscore_passthrough_gen
    commands:
      - command: manifest.load
      - func: "git get project and add git tag"
      - func: "get and apply version expansions"
      - func: "f_expansions_write"
      - func: "kill processes"
      - func: "cleanup environment"
      - func: "set up venv"
      - func: "fetch packages"
      - func: "f_expansions_write"
      - func: "generate compile expansions"
      - func: "apply compile expansions"
      - func: "f_expansions_write"
      - func: "set up remote credentials"
        vars:
          aws_key_remote: ${repo_aws_key}
          aws_secret_remote: ${repo_aws_secret}
      - func: "set up notary client credentials"
      - func: "f_expansions_write"
      - command: subprocess.exec
        params:
          binary: bash
          silent: true
          args:
            - "./src/evergreen/container_registry_login.sh"
      - command: subprocess.exec
        params:
          binary: bash
          env:
            AWS_ACCESS_KEY_ID: ${upload_lock_access_key_id}
            AWS_SECRET_ACCESS_KEY: ${upload_lock_secret_access_key}
            UPLOAD_LOCK_IMAGE: ${upload_lock_image}
            UPLOAD_BUCKET: ${upload_lock_bucket}
            AWS_REGION: ${upload_lock_region}
            EVERGREEN_TASK_ID: ${task_id}
          args:
            - "./src/evergreen/packages_publish.sh"

  - name: push
    run_on: rhel8.7-small
    tags:
      [
        "assigned_to_jira_team_devprod_build",
        "release_critical",
        "incompatible_development_variant",
        "requires_compile_variant",
        "publish",
      ]
    patchable: false
    depends_on:
      - name: package
      - name: jsCore
      - name: run_dbtest
      - name: replica_sets_jscore_passthrough_gen
    stepback: false
    commands:
      - command: manifest.load
      - func: "git get project and add git tag"
      - func: "get and apply version expansions"
      - func: "f_expansions_write"
      - func: "kill processes"
      - func: "cleanup environment"
      - func: "set up venv"
      - func: "fetch packages"
      - func: "fetch dist tarball"
      # Fetch mongocryptd
      - command: s3.get
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          remote_file: ${mongo_cryptd}
          bucket: mciuploads
          local_file: src/mongo-cryptd.tgz
          build_variants: *mongocryptd_variants
      - func: "f_expansions_write"
      - func: "generate compile expansions"
      - func: "apply compile expansions"
      - func: "f_expansions_write"
      - func: "fetch dist debugsymbols"
      - func: "set up remote credentials"
        vars:
          aws_key_remote: ${repo_aws_key}
          aws_secret_remote: ${repo_aws_secret}
      - func: "f_expansions_write"

      # login to container registry
      - command: subprocess.exec
        params:
          binary: bash
          silent: true
          args:
            - "./src/evergreen/container_registry_login.sh"

      # signing windows artifacts
      - command: subprocess.exec
        params:
          binary: bash
          args:
            - "./src/evergreen/garasign_jsign_sign.sh"

      # signing linux artifacts
      - command: subprocess.exec
        params:
          binary: bash
          args:
            - "./src/evergreen/garasign_gpg_sign.sh"

      # Put the binaries tarball/zipfile
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}
      # Put the cryptd tarball/zipfile
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}
          build_variants: *mongocryptd_variants

      # Put the debug symbols
      # push directly to repo due to limitations in file size SERVER-63432
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          aws_key: ${aws_key}
          permissions: public-read
          local_file: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}
          bucket: ${push_bucket}
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}
          optional: true

      # Put the binaries tarball signature
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sig

      # Put the cryptd tarball signature
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sig
          build_variants: *mongocryptd_variants

      # Put the debug symbols signature
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          aws_key: ${aws_key}
          permissions: public-read
          local_file: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sig
          bucket: build-push-testing
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.sig
          optional: true

      # Put the signed MSI file
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          permissions: public-read
          build_variants: ["enterprise-windows", "windows"]
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.msi
          bucket: build-push-testing
          content_type: application/x-msi
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi

      # Put the binaries tarball sha1
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1
          aws_key: ${aws_key}
          permissions: public-read
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha1

      # Put the cryptd tarball sha1
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1
          aws_key: ${aws_key}
          permissions: public-read
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha1
          build_variants: *mongocryptd_variants

      # Put the debug symbols sha1
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          aws_key: ${aws_key}
          permissions: public-read
          local_file: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha1
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.sha1
          optional: true

      # Push the signed MSI sha1
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          permissions: public-read
          build_variants: ["enterprise-windows", "windows"]
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.msi.sha1
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi.sha1

      # Put the binaries tarball sha256
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256
          permissions: public-read
          aws_key: ${aws_key}
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha256

      # Put the cryptd tarball sha256
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256
          permissions: public-read
          aws_key: ${aws_key}
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha256
          build_variants: *mongocryptd_variants

      # Put the debug symbols sha256
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha256
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.sha256
          optional: true

      # Put the signed MSI sha256
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          build_variants: ["enterprise-windows", "windows"]
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.msi.sha256
          bucket: build-push-testing
          permissions: public-read
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi.sha256
          content_type: text/plain

      # Put the binaries tarball md5
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.md5

      # Put the cryptd tarball md5
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.md5
          build_variants: *mongocryptd_variants

      # Put the debug symbols md5
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.md5
          bucket: build-push-testing
          content_type: text/plain
          permissions: public-read
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.md5
          optional: true

      # Put the signed MSI md5
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          build_variants: ["enterprise-windows", "windows"]
          local_file: src/mongodb-${push_name}-${push_arch}-${suffix}.msi.md5
          bucket: build-push-testing
          permissions: public-read
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi.md5

      - command: subprocess.exec
        params:
          continue_on_err: true
          binary: bash
          env:
            SERVER_TARBALL_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}
            SERVER_TARBALL_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}
            CRYPTD_TARBALL_PATH: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}
            CRYPTD_TARBALL_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}
            SOURCE_TARBALL_PATH: src/mongodb-src-${src_suffix}.${ext|tar.gz}
            SOURCE_TARBALL_KEY: ${version_id}/${build_id}/push/src/mongodb-src-${src_suffix}.${ext|tar.gz}
            DEBUG_SYMBOLS_TARBALL_PATH: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}
            DEBUG_SYMBOLS_TARBALL_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}
            SERVER_TARBALL_SIGNATURE_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig
            SERVER_TARBALL_SIGNATURE_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig
            CRYPTD_TARBALL_SIGNATURE_PATH: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig
            CRYPTD_TARBALL_SIGNATURE_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig
            SOURCE_TARBALL_SIGNATURE_PATH: src/mongodb-src-${src_suffix}.${ext|tar.gz}.sig
            SOURCE_TARBALL_SIGNATURE_KEY: ${version_id}/${build_id}/push/src/mongodb-src-${src_suffix}.${ext|tar.gz}.sig
            DEBUG_SYMBOLS_TARBALL_SIGNATURE_PATH: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sig
            DEBUG_SYMBOLS_TARBALL_SIGNATURE_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sig
            MSI_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.msi
            MSI_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi
            SERVER_TARBALL_SHA1_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1
            SERVER_TARBALL_SHA1_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1
            CRYPTD_TARBALL_SHA1_PATH: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1
            CRYPTD_TARBALL_SHA1_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1
            SOURCE_TARBALL_SHA1_PATH: src/mongodb-src-${src_suffix}.${ext|tar.gz}.sha1
            SOURCE_TARBALL_SHA1_KEY: ${version_id}/${build_id}/push/src/mongodb-src-${src_suffix}.${ext|tar.gz}.sha1
            DEBUG_SYMBOLS_TARBALL_SHA1_PATH: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha1
            DEBUG_SYMBOLS_TARBALL_SHA1_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha1
            MSI_SHA1_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.msi.sha1
            MSI_SHA1_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi.sha1
            SERVER_TARBALL_SHA256_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256
            SERVER_TARBALL_SHA256_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256
            CRYPTD_TARBALL_SHA256_PATH: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256
            CRYPTD_TARBALL_SHA256_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256
            SOURCE_TARBALL_SHA256_PATH: src/mongodb-src-${src_suffix}.${ext|tar.gz}.sha256
            SOURCE_TARBALL_SHA256_KEY: ${version_id}/${build_id}/push/src/mongodb-src-${src_suffix}.${ext|tar.gz}.sha256
            DEBUG_SYMBOLS_TARBALL_SHA256_PATH: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha256
            DEBUG_SYMBOLS_TARBALL_SHA256_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha256
            MSI_SHA256_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.msi.sha256
            MSI_SHA256_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi.sha256
            SERVER_TARBALL_MD5_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5
            SERVER_TARBALL_MD5_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5
            CRYPTD_TARBALL_MD5_PATH: src/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5
            CRYPTD_TARBALL_MD5_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5
            SOURCE_TARBALL_MD5_PATH: src/mongodb-src-${src_suffix}.${ext|tar.gz}.md5
            SOURCE_TARBALL_MD5_KEY: ${version_id}/${build_id}/push/src/mongodb-src-${src_suffix}.${ext|tar.gz}.md5
            DEBUG_SYMBOLS_TARBALL_MD5_PATH: src/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.md5
            DEBUG_SYMBOLS_TARBALL_MD5_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.md5
            MSI_MD5_PATH: src/mongodb-${push_name}-${push_arch}-${suffix}.msi.md5
            MSI_MD5_KEY: ${version_id}/${build_id}/push/${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi.md5
            AWS_ACCESS_KEY_ID: ${upload_lock_access_key_id}
            AWS_SECRET_ACCESS_KEY: ${upload_lock_secret_access_key}
            UPLOAD_LOCK_IMAGE: ${upload_lock_image}
            UPLOAD_BUCKET: ${upload_lock_bucket}
            AWS_REGION: ${upload_lock_region}
            EVERGREEN_TASK_ID: ${task_id}
          args:
            - "./src/evergreen/run_upload_lock_push.sh"

      - command: s3Copy.copy
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          s3_copy_files:
            #Binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}",
                    "bucket": "${push_bucket}",
                  },
              }

            #Cryptd
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": *mongocryptd_variants,
              }

            #MSI (Windows only)
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": ["enterprise-windows", "windows"],
              }

            #Binaries Signature
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sig",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig",
                    "bucket": "${push_bucket}",
                  },
              }

            #Cryptd Signature
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sig",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": *mongocryptd_variants,
              }

            #SHA1 for binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha1",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1",
                    "bucket": "${push_bucket}",
                  },
              }

            #SHA1 for cryptd
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha1",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": *mongocryptd_variants,
              }

            #SHA1 for MSI
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi.sha1",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi.sha1",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": ["enterprise-windows", "windows"],
              }

            #SHA256 for binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha256",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256",
                    "bucket": "${push_bucket}",
                  },
              }

            #SHA256 for cryptd
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha256",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": *mongocryptd_variants,
              }

            #SHA256 for MSI files
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi.sha256",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi.sha256",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": ["enterprise-windows", "windows"],
              }

            #MD5 for binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.md5",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5",
                    "bucket": "${push_bucket}",
                  },
              }

            #MD5 for cryptd
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.md5",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-cryptd-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": *mongocryptd_variants,
              }

            #MD5 for MSIs
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-${suffix}-${task_id}-signed.msi.md5",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-${suffix}-signed.msi.md5",
                    "bucket": "${push_bucket}",
                  },
                "build_variants": ["enterprise-windows", "windows"],
              }

      # Debug symbols are not created for all variants and the copy is optional.
      - command: s3Copy.copy
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          optional: true
          s3_copy_files:
            #Debug Symbols temporarily removed - see SERVER-63432 - need to s3.push debugsymbols due to size limit
            #Debug Symbols Signature
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.sig",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sig",
                    "bucket": "${push_bucket}",
                  },
              }

            #SHA1 for debug symbols
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.sha1",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha1",
                    "bucket": "${push_bucket}",
                  },
              }

            #SHA256 for debugsymbols
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.sha256",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.sha256",
                    "bucket": "${push_bucket}",
                  },
              }

            #MD5 for debugsymbols
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}-${task_id}.${ext|tgz}.md5",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongodb-${push_name}-${push_arch}-debugsymbols-${suffix}.${ext|tgz}.md5",
                    "bucket": "${push_bucket}",
                  },
              }

  - name: crypt_push
    run_on: rhel8.7-small
    tags:
      [
        "assigned_to_jira_team_server_security",
        "release_critical",
        "incompatible_development_variant",
        "incompatible_community",
        "requires_compile_variant",
        "publish_crypt",
      ]
    patchable: false
    stepback: false
    depends_on:
      - name: crypt_create_lib
    commands:
      - command: manifest.load
      - func: "f_expansions_write"
      - func: "git get project and add git tag"
      - func: "set task expansion macros"
      - func: "f_expansions_write"
      - func: "kill processes"
      - func: "cleanup environment"
      - func: "set up venv"
      - func: "upload pip requirements"
      - func: "get buildnumber"
      - func: "f_expansions_write"
      - func: "get and apply version expansions"
      - func: "f_expansions_write"
      - func: "generate compile expansions"
      - func: "apply compile expansions"
      - func: "f_expansions_write"
      - command: s3.get
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          remote_file: ${project}/mongo_crypt/${build_variant}/${revision}/mongo_crypt_shared_v1-${version}.${ext|tgz}
          bucket: mciuploads
          local_file: src/mongo_crypt_shared_v1.${ext|tgz}
      - func: "f_expansions_write"
      - func: "generate compile expansions"
      - func: "apply compile expansions"
      - func: "f_expansions_write"
      - func: "set up remote credentials"
        vars:
          aws_key_remote: ${repo_aws_key}
          aws_secret_remote: ${repo_aws_secret}
      - func: "f_expansions_write"
      # login to container registry
      - command: subprocess.exec
        params:
          binary: bash
          silent: true
          args:
            - "./src/evergreen/container_registry_login.sh"
      - command: subprocess.exec
        params:
          binary: bash
          args:
            - "./src/evergreen/garasign_gpg_crypt_sign.sh"
      # Put the crypt tarball/zipfile
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}
      # Put the crypt tarball signature
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sig
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: ${content_type|application/gzip}
          remote_file: ${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sig
      # Put the crypt tarball sha1
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1
          aws_key: ${aws_key}
          permissions: public-read
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha1
      # Put the crypt tarball sha256
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256
          permissions: public-read
          aws_key: ${aws_key}
          bucket: build-push-testing
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha256
      # Put the crypt tarball md5
      - command: s3.put
        params:
          aws_secret: ${aws_secret}
          local_file: src/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5
          aws_key: ${aws_key}
          bucket: build-push-testing
          permissions: public-read
          content_type: text/plain
          remote_file: ${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.md5
      - command: s3Copy.copy
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          s3_copy_files:
            #Binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}",
                    "bucket": "${push_bucket}",
                  },
              }
            #SHA1 for binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha1",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha1",
                    "bucket": "${push_bucket}",
                  },
              }
            #SHA256 for binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.sha256",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}.sha256",
                    "bucket": "${push_bucket}",
                  },
              }
            #MD5 for binaries
            - {
                "source":
                  {
                    "path": "${push_path}-STAGE/${push_name}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}-${task_id}.${ext|tgz}.md5",
                    "bucket": "build-push-testing",
                  },
                "destination":
                  {
                    "path": "${push_path}/mongo_crypt_shared_v1-${push_name}-${push_arch}-${suffix}.${ext|tgz}.md5",
                    "bucket": "${push_bucket}",
                  },
              }

  # Test a compilation without extra args from evergreen to simulate local dev compilation.
  - name: scons_dev_compile_smoke_test
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "get version expansions"
      - func: "apply version expansions"
      - func: "f_expansions_write"
      - func: "scons raw compile"
        vars:
          targets: >-
            install-wiredtiger
            compiledb
          task_compile_flags: >-
            --opt=off
            --dbg=on
      - func: "scons raw compile"
        vars:
          targets: >-
            install-wiredtiger
            compiledb
          task_compile_flags: >-
            --opt=on
            --dbg=off

  # Test a ninja compilation without extra args from evergreen to simulate local dev compilation.
  - name: ninja_dev_compile_smoke_test
    tags: ["assigned_to_jira_team_devprod_build", "auxiliary"]
    depends_on:
      - name: version_expansions_gen
        variant: generate-tasks-for-version
    commands:
      - func: "get version expansions"
      - func: "apply version expansions"
      - func: "f_expansions_write"
      - func: "scons raw compile"
        vars:
          targets: >-
            install-wiredtiger
            compiledb
          task_compile_flags: >-
            --ninja build.ninja
      - func: "f_expansions_write"
      - func: "ninja compile"
        vars:
          ninja_file: "build.ninja"
          targets: "compiledb"

################################################
#                 Task Groups                  #
################################################
task_groups:
  - <<: *compile_task_group_template
    name: compile_dist_test_TG
    tasks:
      - compile_dist_test

  - <<: *compile_bazel_task_group_template
    name: compile_bazel_TG
    tasks:
      - compile_dist_test_quick

  - <<: *compile_bazel_task_group_template
    name: run_bazel_TG
    tasks:
      - run_bazel_program

  - <<: *compile_task_group_template
    name: bazel_workstation_TG
    tasks:
      - bazel_workstation_unittests

  - <<: *compile_bazel_task_group_template
    name: compile_bazel_ninja_TG
    tasks:
      - compile_ninja_bazel

  - <<: *compile_bazel_task_group_template
    name: compile_bazel_windows_TG
    tasks:
      - run_bazel_program_windows

  - <<: *compile_bazel_task_group_template
    name: compile_bazel_macos_TG
    tasks:
      - compile_dist_test_quick

  - <<: *compile_task_group_template
    name: compile_upload_benchmarks_TG
    tasks:
      - compile_upload_benchmarks
      # TODO(SERVER-86426): Figure out a workable long-term solution to benchmark debug symbols
      # - compile_upload_benchmarks_debug

  - <<: *compile_task_group_template
    name: compile_and_archive_dist_test_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug

  - <<: *compile_task_group_template
    name: compile_and_archive_dist_test_then_package_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug
      - package

  - <<: *compile_task_group_template
    name: compile_ninja_next_TG
    tasks:
      - compile_ninja_next

  - <<: *compile_task_group_template
    name: compile_ninja_TG
    tasks:
      - compile_ninja
    teardown_task:
      - command: s3.put
        params:
          optional: true
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/all.build.ninja
          remote_file: ${project}/${build_variant}/${revision}/artifacts/all.${build_id}.build.ninja
          bucket: mciuploads
          permissions: public-read
          content_type: text/plain
          display_name: build.ninja

  - <<: *compile_task_group_template
    name: compile_ninja_quick_TG
    tasks:
      - compile_ninja_quick

  - <<: *compile_task_group_template
    name: compile_ninja_default_profile_TG
    tasks:
      - compile_ninja_default_profile

  - <<: *compile_task_group_template
    name: compile_ninja_default_profile_linux_TG
    tasks:
      - compile_ninja_default_profile_linux

  - <<: *compile_task_group_template
    name: compile_ninja_opt_profile_TG
    tasks:
      - compile_ninja_opt_profile

  - <<: *compile_task_group_template
    name: compile_ninja_san_profile_TG
    tasks:
      - compile_ninja_san_profile

  - <<: *compile_task_group_template
    name: compile_ninja_fast_profile_TG
    tasks:
      - compile_ninja_fast_profile

  - <<: *compile_task_group_template
    name: compile_ninja_fast_icecc_TG
    tags: []
    tasks:
      - compile_ninja_fast_icecc

  - <<: *compile_task_group_template
    name: compile_ninja_compiledb_profile_TG
    tasks:
      - compile_ninja_compiledb_profile

  - <<: *compile_task_group_template
    name: compile_run_and_archive_dbtest_TG
    tasks:
      - compile_dbtest
      - run_dbtest
      - archive_dbtest

  - <<: *compile_task_group_template
    name: compile_test_serial_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug
      - compile_dbtest
      - run_dbtest
      - archive_dbtest

  - <<: *compile_task_group_template
    name: compile_jstestshell_TG
    tasks:
      - archive_jstestshell
      - archive_jstestshell_debug

  - <<: *compile_task_group_template
    name: compile_test_serial_future_git_tag_multiversion_TG
    tasks:
      - compile_dist_test_future_git_tag_multiversion
      - archive_dist_test_future_git_tag_multiversion
      - archive_dist_test_debug_future_git_tag_multiversion
      - compile_unittests_future_git_tag_multiversion
      - run_unittests_future_git_tag_multiversion
      - compile_dbtest_future_git_tag_multiversion
      - run_dbtest_future_git_tag_multiversion
      - archive_dbtest_future_git_tag_multiversion
      - compile_all_future_git_tag_multiversion

  - <<: *compile_task_group_template
    name: compile_test_and_package_serial_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug
      # package task here to reduce peak diskspace SERVER-86662
      - package
      - compile_dbtest
      - run_dbtest
      - archive_dbtest

  # The *no_unittests_TG taskgroups are useful for static builds,
  # were the static binaries of the unittests can take up to
  # a terabyte of data.
  - <<: *compile_task_group_template
    name: compile_test_serial_no_unittests_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug
      - compile_dbtest
      - run_dbtest
      - archive_dbtest
      - compile_all_but_not_unittests

  - <<: *compile_task_group_template
    name: compile_test_and_package_serial_no_unittests_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug
      # package task here to reduce peak diskspace SERVER-86662
      - package
      - compile_dbtest
      - run_dbtest
      - archive_dbtest
      - compile_all_but_not_unittests

  # TODO: SERVER-79886 Fix commented out tasks
  - <<: *compile_task_group_template
    name: compile_test_and_package_serial_lto_no_unittests_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug
      # package task here to reduce peak diskspace SERVER-86662
      - package
      - compile_dbtest
    # - run_dbtest
    # - archive_dbtest
    # - compile_all_but_not_unittests

  # The *no_unittests_TG taskgroups are useful for static builds,
  # were the static binaries of the unittests can take up to
  # a terabyte of data.
  - <<: *compile_task_group_template
    name: compile_test_benchmark_and_package_serial_no_unittests_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug
      # package task here to reduce peak diskspace SERVER-86662
      - package
      - compile_dbtest
      - run_dbtest
      - archive_dbtest
      - compile_upload_benchmarks
      # TODO(SERVER-86426): Figure out a workable long-term solution to benchmark debug symbols
      # - compile_upload_benchmarks_debug
      - compile_all_but_not_unittests

  - <<: *compile_task_group_template
    name: compile_test_parallel_unittest_stream_TG
    max_hosts: -1
    tasks:
      - compile_libraries_for_unittests
      - compile_and_run_unittests_first_quarter
      - compile_and_run_unittests_second_quarter
      - compile_and_run_unittests_third_quarter
      - compile_and_run_unittests_fourth_quarter

  - <<: *compile_task_group_template
    name: compile_unittest_libaries_TG
    max_hosts: -1
    tasks:
      - compile_libraries_for_unittests

  # These `parallel` task groups are only appropriate for builders that
  # use --link-model=dynamic, and have scons_cache_scope: shared and
  # scons_cache_mode: all. Such builders are able to share all build
  # artifacts, and therefore will not repeatedly re-link the same
  # code. In that mode, it makes sense to run all of these tasks
  # concurrently, since they will share state across machines and can
  # complete faster than running them serially. We keep them in task
  # groups so that if they do run on the same machine, they can avoid the
  # cost of re-running the setup tasks.
  - <<: *compile_task_group_template
    name: compile_test_parallel_core_stream_TG
    tasks:
      - compile_dist_test
      - determine_patch_tests
      - archive_dist_test
      - archive_dist_test_debug
      - compile_all_but_not_unittests

  - <<: *compile_task_group_template
    name: compile_test_parallel_core_stream_no_compile_all_TG
    tasks:
      - compile_dist_test
      - archive_dist_test
      - archive_dist_test_debug

  - <<: *compile_task_group_template
    name: compile_all_but_not_unittests_TG
    tasks:
      - compile_all_but_not_unittests

  - <<: *compile_task_group_template
    name: compile_test_parallel_dbtest_stream_TG
    tasks:
      - compile_dbtest
      - run_dbtest
      - archive_dbtest

  - <<: *compile_task_group_template
    name: scons_compile_smoke_test_TG
    tasks:
      - scons_dev_compile_smoke_test

  - <<: *compile_task_group_template
    name: ninja_compile_smoke_test_TG
    tasks:
      - ninja_dev_compile_smoke_test

  - name: crypt_build_debug_and_test
    setup_task:
      - func: "f_expansions_write"
      - func: "apply compile expansions"
      - func: "f_expansions_write"
      - func: "set task expansion macros"
      - func: "f_expansions_write"
      - func: "get engflow creds"
    teardown_task:
      - func: "attach scons logs"
    setup_group_can_fail_task: true
    setup_group:
      - command: manifest.load
      - func: "git get project and add git tag"
      - func: "set task expansion macros"
      - func: "f_expansions_write"
      - func: "kill processes"
      - func: "cleanup environment"
      - func: "set up venv"
      - func: "upload pip requirements"
      - func: "get buildnumber"
      - func: "f_expansions_write"
      - func: "set up win mount script"
      - func: "f_expansions_write"
      - func: "generate compile expansions"
    teardown_group:
      - func: "f_expansions_write"
      - func: "umount shared scons directory"
    max_hosts: 1
    tasks:
      - "crypt_create_debug_lib"
      - "crypt_install_tests"
      - "crypt_run_tests"
