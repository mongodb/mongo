# Miscellaneous build variants
#
# After the branching variants in this file
# should continue to run on a new rapid release (v7.1, v7.2 etc.)
# and LTS release (v7.0, v6.0 etc.) branch projects

buildvariants:
  - name: test-release
    display_name: "Test Release"
    # tasks may use "Admin Only" variables, so patch runs may only succeed for admins
    allowed_requesters: ["commit", "patch"]
    tags: ["assigned_to_jira_team_devprod_release_infrastructure"]
    activate: true
    run_on: ubuntu2404-small
    modules:
      - devprod_coverity
    tasks:
      - name: publish-sast-report

  - name: test-release-sbom
    activate: false
    display_name: "Test Release SBOM Upload"
    # The build variant is aimed for publish-augmented-sbom task testing.
    # For end-to-end tests:
    ## - Create new test branch from 10gen/mongo
    ## - Change SilkBomb branch argument to the new test branch in the task.
    ## - Cleanup results in DependencyTracker.
    # Note: The task may use "Admin Only" variables, so patch runs may only succeed for Evergreen Project admins
    allowed_requesters: ["patch"]
    tags: ["assigned_to_jira_team_platsec_server"]
    run_on: ubuntu2404-small
    modules:
      - devprod_coverity
    tasks:
      - name: publish-augmented-sbom

  - name: upload-sbom-if-changed
    display_name: "Upload SBOM if changed"
    allowed_requesters: ["commit", "patch"]
    activate: true
    paths:
      - "sbom.json"
    tags: []
    run_on:
      - rhel8.8-small
    stepback: false
    tasks:
      - name: upload_sbom_via_silkbomb_if_changed

  - name: create_sbom_and_pr
    display_name: "Generate SBOM files and create PR"
    # Don't run as part of patch builds
    patchable: false
    # Run at 6 am UTC Mon-Fri
    cron: "0 6 * * 1-5"
    run_on: rhel92-small
    expansions:
      ENDOR_NAMESPACE: mongodb.10gen
    stepback: false
    tasks:
      - name: update_sbom
