# Amazon build variants for testing release environments
#
# After the branching variants in this file
# should continue to run on a new rapid release (v7.1, v7.2 etc.)
# and LTS release (v7.0, v6.0 etc.) branch projects

# This variant builds the "mongostream" container image used in
# Atlas Stream Processing production services. mongostream is just a mongod
# binary with the streams module compiled in.
buildvariants:
  - name: enterprise-amazon2023-streams
    display_name: "Amazon Linux 2023 enterprise build with streams"
    cron: "0 3 * * *" # From the ${project_nightly_cron} parameter.
    modules: ["asp-js-engine"]
    run_on:
      - amazon2023-latest-small
    expansions:
      test_flags: >-
        --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,requires_external_data_source,requires_ldap_pool
        --additionalFeatureFlags=featureFlagStreams
      push_path: linux
      push_bucket: downloads.10gen.com
      push_bucket_new: cdn-origin-mongodb-server-enterprise
      push_role_arn: arn:aws:iam::119629040606:role/s3-access.cdn-origin-mongodb-server-enterprise
      push_name: linux
      push_arch: x86_64-enterprise-amazon2023-streams
      mciuploads_binary_permissions_push: public-read
      mciuploads_binary_visibility_push: public
      bazel_compile_flags: >-
        --define=MONGO_DISTMOD=amazon2023
        --streams_release_build=True
      multiversion_platform: amazon2023
      multiversion_edition: enterprise-streams
      has_packages: true
      packager_script: packager_enterprise.py
      packager_arch: x86_64
      packager_distro: amazon2023
      repo_edition: enterprise
      compile_variant: enterprise-amazon2023-streams
      large_distro_name: amazon2023.3-c5-24xlarge
    tasks:
      - name: compile_and_archive_dist_test_TG
        distros:
          - amazon2023.3-c5-24xlarge
      - name: aggregation
      - name: streams_gen
      - name: streams_kafka_gen
      - name: streams_kafka_gwproxy
      - name: streams_kafka_benchmark
      - name: streams_https
      - name: streams_lambda
      - name: streams_s3
      - name: streams_kinesis
      - name: streams_aspio
      - name: streams_aspio_iceberg_0
      - name: streams_aspio_iceberg_1
      - name: streams_aspio_iceberg_2
      - name: streams_aspio_iceberg_3
      - name: streams_aspio_iceberg_4
      - name: streams_aspio_pubsub
      - name: streams_build_and_push_gen
      - name: streams_skip_tests_build_and_push_gen
      - name: generate_buildid_to_debug_symbols_mapping

  - name: enterprise-amazon2023-streams-arm64
    display_name: "Amazon Linux 2023 enterprise build with streams arm64"
    cron: "0 3 * * *" # From the ${project_nightly_cron} parameter.
    modules: ["asp-js-engine"]
    run_on:
      - amazon2023-arm64-latest-m8g-xlarge
    expansions:
      test_flags: >-
        --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,requires_external_data_source,requires_ldap_pool
        --additionalFeatureFlags=featureFlagStreams
      push_path: linux
      push_bucket: downloads.10gen.com
      push_bucket_new: cdn-origin-mongodb-server-enterprise
      push_role_arn: arn:aws:iam::119629040606:role/s3-access.cdn-origin-mongodb-server-enterprise
      push_name: linux
      push_arch: aarch64-enterprise-amazon2023-streams
      mciuploads_binary_permissions_push: public-read
      mciuploads_binary_visibility_push: public
      bazel_compile_flags: >-
        --define=MONGO_DISTMOD=amazon2023
        --streams_release_build=True
      multiversion_platform: amazon2023
      multiversion_edition: enterprise-streams
      has_packages: true
      packager_script: packager_enterprise.py
      packager_arch: aarch64
      packager_distro: amazon2023
      repo_edition: enterprise
      compile_variant: enterprise-amazon2023-streams-arm64
      large_distro_name: amazon2023.3-arm64-xxxlarge
    tasks:
      - name: compile_and_archive_dist_test_TG
        distros:
          - amazon2023.3-arm64-xxxlarge
      - name: streams_gen
      - name: streams_kafka_gen
      - name: streams_kafka_gwproxy
      - name: streams_kafka_benchmark
      - name: streams_kinesis
      - name: streams_https
      - name: streams_lambda
      - name: streams_s3
      - name: aggregation
      - name: streams_aspio
      - name: streams_aspio_iceberg_0
      - name: streams_aspio_iceberg_1
      - name: streams_aspio_iceberg_2
      - name: streams_aspio_iceberg_3
      - name: streams_aspio_iceberg_4
      - name: streams_aspio_pubsub
      - name: streams_build_and_push_gen
      - name: streams_skip_tests_build_and_push_gen
      # Only needed once to generate the streams manifest for both x86 and arm
      - name: streams_publish_manifest_al2023_gen
      - name: generate_buildid_to_debug_symbols_mapping
