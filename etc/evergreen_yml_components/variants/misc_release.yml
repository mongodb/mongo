# All remaining release variants not included in other files.

variables:
# THIS HAS COPIES IN evergreen.yml and try_sbe_engine.yml - ANY MODIFICATIONS HERE SHOULD ALSO BE
# MADE IN THAT FILE.
- &amazon_linux2_arm64_compile_variant_dependency
  depends_on:
  - name: archive_dist_test_debug
    variant: &amazon_linux2_arm64_compile_variant_name amazon-linux2-arm64-compile
  - name: version_gen
    variant: generate-tasks-for-version
    # This is added because of EVG-18211.
    # Without this we are adding extra dependencies on evergreen and it is causing strain
    omit_generated_tasks: true

# THIS HAS COPIES IN evergreen.yml and try_sbe_engine.yml - ANY MODIFICATIONS HERE SHOULD ALSO BE
# MADE IN THAT FILE.
- &linux_arm64_generic_expansions
  multiversion_platform: amazon2
  multiversion_edition: enterprise
  multiversion_architecture: aarch64
  packager_arch: aarch64
  packager_distro: amazon2
  repo_edition: enterprise
  large_distro_name: amazon2-arm64-latest-large
  num_scons_link_jobs_available: 0.99
  compile_variant: *amazon_linux2_arm64_compile_variant_name

buildvariants:
- name: amazon2
  display_name: Amazon Linux 2
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-latest-small
  expansions:
    test_flags: >-
      --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-amazon2
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    multiversion_platform: amazon2
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: amazon2
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: amazon2-latest-large
    compile_variant: amazon2
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-latest-large
  - name: .aggfuzzer .common !.feature_flag_guarded
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: libunwind_tests
  - name: .logical_session_cache .one_sec
  - name: multiversion_gen
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: .sharding .common !.csrs !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .sharding .txns
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-amazon2
  display_name: "Enterprise Amazon Linux 2"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-latest-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
    # TODO BUILD-13887 should fix uses_pykmip incompatibility.
    test_flags: >-
      --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,uses_pykmip,requires_external_data_source,requires_latch_analyzer
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-amazon2
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    multiversion_platform: amazon2
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: amazon2
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-amazon2
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-latest-large
  - name: .aggfuzzer .common !.feature_flag_guarded
  - name: aggregation !.feature_flag_guarded
  - name: audit
  - name: .auth !.multiversion
  - name: causally_consistent_jscore_txns_passthrough
  - name: .encrypt !.aggregation
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: libunwind_tests
  - name: .logical_session_cache .one_sec
  - name: noPassthrough_gen
  - name: noPassthroughWithMongod_gen
  - name: .replica_sets .common
  - name: sasl
  - name: serial_run
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: .sharding .txns !.csrs
  - name: slow1_gen
  - name: .stitch
  - name: .crypt
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: amazon2-arm64
  display_name: Amazon Linux 2 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-arm64-latest-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-amazon2
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: aarch64
    packager_distro: amazon2
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: amazon2-arm64-latest-large
    compile_variant: amazon2-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-arm64-latest-large
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - amazon2-arm64-latest-large
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.multiversion !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-amazon2-arm64
  display_name: "Enterprise Amazon Linux 2 arm64"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-arm64-latest-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-amazon2
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    # TODO BUILD-13887 should fix uses_pykmip incompatibility.
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,uses_pykmip,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: true
    multiversion_platform: amazon2
    multiversion_edition: enterprise
    multiversion_architecture: aarch64
    packager_script: packager_enterprise.py
    packager_arch: aarch64
    packager_distro: amazon2
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-amazon2-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-arm64-latest-large
  - name: compile_integration_and_test_parallel_stream_TG
    distros:
    - amazon2-arm64-latest-large
  - name: test_api_version_compatibility
  - name: .aggfuzzer !.feature_flag_guarded
  - name: .aggregation !.feature_flag_guarded
  - name: audit
  - name: .auth
  - name: .causally_consistent !.sharding
  - name: .change_streams
  - name: .change_stream_fuzzer
  - name: .misc_js
  - name: .concurrency !.large !.ubsan !.no_txns
  - name: .concurrency .large !.ubsan !.no_txns
    distros:
    - amazon2-arm64-latest-large
  - name: .config_fuzzer !.large
  - name: .config_fuzzer .large
    distros:
    - amazon2-arm64-latest-large
  - name: disk_wiredtiger
  - name: .encrypt
  - name: idl_tests
  - name: initial_sync_fuzzer_gen
  - name: jsCore
    distros:
    - amazon2-arm64-latest-large
  - name: .jscore .common !jsCore !.feature_flag_guarded
  - name: jsCore_min_batch_repeat_queries_ese_gsm
  - name: jsCore_txns_large_txns_format
  - name: json_schema
  - name: .jstestfuzz !.flow_control  # Flow control jstestfuzz take longer.
  - name: libunwind_tests
  - name: .multi_shard
  - name: multi_stmt_txn_jscore_passthrough_with_migration_gen
  - name: .query_fuzzer
  - name: query_stats_aggregation_passthrough
  - name: query_stats_mongos_aggregation_passthrough
  - name: query_stats_mongos_passthrough
  - name: query_stats_passthrough
  - name: .read_write_concern .large
    distros:
    - amazon2-arm64-latest-large
  - name: .read_write_concern !.large
  - name: .replica_sets !.encrypt !.auth
    distros:
    - amazon2-arm64-latest-large
  - name: replica_sets_api_version_jscore_passthrough_gen
  - name: replica_sets_reconfig_jscore_passthrough_gen
  - name: retryable_writes_jscore_passthrough_gen
  - name: retryable_writes_jscore_stepdown_passthrough_gen
    distros:
    - amazon2-arm64-latest-large
  - name: .read_only
  - name: .rollbackfuzzer
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: session_jscore_passthrough
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: sharding_api_version_jscore_passthrough_gen
  - name: .sharding .txns
  - name: .sharding .common
  - name: .stitch
  - name: .crypt
    distros:
    - amazon2-arm64-latest-large
  - name: .publish_crypt
  - name: secondary_reads_passthrough_gen
  - name: server_discovery_and_monitoring_json_test_TG
  - name: .serverless
    distros:
    - amazon2-arm64-latest-large
  - name: server_selection_json_test_TG
    distros:
    - amazon2-arm64-latest-large
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: amazon2023
  display_name: Amazon Linux 2023
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.0-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-amazon2023
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2023
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: amazon2023
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: amazon2023.0-large
    compile_variant: amazon2023
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.0-large
  - name: aggregation
  - name: .auth !.audit !.multiversion
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - amazon2023.0-large
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.multiversion !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- <<: *amazon_linux2_arm64_compile_variant_dependency
  name: &amazon-linux2-arm64-fixed-concurrent-transactions amazon-linux2-arm64-fixed-concurrent-transactions
  display_name: "Amazon Linux 2 arm64 Enterprise (Fixed Concurrent Transactions)"
  cron: "0 0 * * 0" # From the ${project_nightly_cron} parameter. Runs every Sunday.
  run_on:
    - amazon2-arm64-latest-small
  expansions:
    <<: *linux_arm64_generic_expansions
    test_flags: >-
      --mongodSetParameters="{storageEngineConcurrencyAdjustmentAlgorithm: fixedConcurrentTransactions}"
      --excludeWithAnyTags=incompatible_with_amazon_linux,incompatible_with_shard_merge,requires_external_data_source,requires_latch_analyzer
    scons_cache_scope: shared
    scons_cache_mode: all
    commit_queue_alternate_cache: amazon-linux2-arm64-compile
    has_packages: false
  tasks:
  - name: analyze_shard_key_jscore_passthrough_gen
  - name: query_golden_classic
  - name: lint_fuzzer_sanity_patch
  - name: test_api_version_compatibility
  - name: check_feature_flag_tags
  - name: check_for_todos
  - name: .aggfuzzer !.feature_flag_guarded
  - name: .aggregation !.feature_flag_guarded
  - name: aggregation_repeat_queries
  - name: audit
  - name: .auth
  - name: buildscripts_test
  - name: resmoke_end2end_tests
  - name: unittest_shell_hang_analyzer_gen
  - name: .causally_consistent !.sharding
  - name: .change_streams
  - name: .change_stream_fuzzer
  # TODO SERVER-57866: Remove the explicit mentions of change stream multitenant suites.
  - name: change_streams_multitenant_passthrough
  - name: .misc_js
  - name: .clustered_collections
  - name: .concurrency !.large !.ubsan !.no_txns
  - name: .concurrency .large !.ubsan !.no_txns
  - name: .config_fuzzer !.large
  - name: .config_fuzzer .large
    distros:
    - amazon2-arm64-latest-large
  - name: .config_fuzzer_stress
    distros:
    - amazon2-arm64-latest-large
  - name: disk_wiredtiger
  - name: .encrypt
  - name: idl_tests
  - name: initial_sync_fuzzer_gen
  - name: .jscore .common
  - name: jsCore_min_batch_repeat_queries_ese_gsm
  - name: jsCore_txns_large_txns_format
  - name: jsCore_wildcard_indexes
  - name: json_schema
  - name: .jstestfuzz !.flow_control  # Flow control jstestfuzz take longer.
  - name: libunwind_tests
  - name: .multi_shard
  - name: multi_stmt_txn_jscore_passthrough_with_migration_gen
  - name: multiversion_gen
  - name: .query_fuzzer
  - name: .random_multiversion_ds
  - name: .read_write_concern .large
  - name: .read_write_concern !.large
  - name: .replica_sets !.encrypt !.auth !.ignore_non_generated_replica_sets_jscore_passthrough
  - name: replica_sets_jscore_passthrough_gen
  - name: replica_sets_api_version_jscore_passthrough_gen
  - name: replica_sets_reconfig_jscore_passthrough_gen
  - name: replica_sets_reconfig_jscore_stepdown_passthrough_gen
  - name: replica_sets_reconfig_kill_primary_jscore_passthrough_gen
  - name: retryable_writes_jscore_passthrough_gen
  - name: retryable_writes_jscore_stepdown_passthrough_gen
  - name: .read_only
  - name: .rollbackfuzzer
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: secondary_reads_passthrough_gen
  - name: .serverless
    distros:
    - amazon2-arm64-latest-large
  - name: session_jscore_passthrough
  - name: .shard_split
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: sharding_api_version_jscore_passthrough_gen
  - name: sharding_api_strict_passthrough_gen
  - name: .sharding .txns
  - name: .sharding .common
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_ese_gcm_gen
  - name: sharded_multi_stmt_txn_jscore_passthrough
  - name: .updatefuzzer
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl

- name: enterprise-amazon2023
  display_name: "Enterprise Amazon Linux 2023"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.0-small
  expansions:
    additional_package_targets: archive-mongocryptd archive-mongocryptd-debug archive-mh archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-amazon2023
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2023
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    crypt_task_compile_flags: SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique" CCFLAGS="-fno-gnu-unique"
    # TODO BUILD-13887 should fix uses_pykmip incompatibility.
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,uses_pykmip,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: true
    multiversion_platform: amazon2023
    multiversion_edition: enterprise
    multiversion_architecture: x86_64
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: amazon2023
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-amazon2023
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.0-large
  - name: test_api_version_compatibility
  - name: .aggfuzzer !.feature_flag_guarded !.multiversion
  - name: .aggregation !.feature_flag_guarded
  - name: audit
  - name: .auth !.multiversion
  - name: .causally_consistent !.sharding
  - name: .change_streams
  - name: .change_stream_fuzzer
  - name: .misc_js
  - name: .concurrency !.large !.ubsan !.no_txns
  - name: .concurrency .large !.ubsan !.no_txns
    distros:
    - amazon2023.0-large
  - name: config_fuzzer_concurrency
  - name: config_fuzzer_jsCore
  - name: disk_wiredtiger
  - name: .encrypt
  - name: idl_tests
  - name: initial_sync_fuzzer_gen
  - name: jsCore
    distros:
    - amazon2023.0-large
  - name: .jscore .common !jsCore !.feature_flag_guarded
  - name: jsCore_txns_large_txns_format
  - name: json_schema
  - name: .jstestfuzz !.flow_control  # Flow control jstestfuzz take longer.
  - name: libunwind_tests
  - name: .multi_shard
  - name: multi_stmt_txn_jscore_passthrough_with_migration_gen
  - name: .query_fuzzer
  - name: .read_write_concern .large
    distros:
    - amazon2023.0-large
  - name: .read_write_concern !.large
  - name: .replica_sets !.encrypt !.auth
    distros:
    - amazon2023.0-large
  - name: replica_sets_api_version_jscore_passthrough_gen
  - name: replica_sets_reconfig_jscore_passthrough_gen
  - name: retryable_writes_jscore_passthrough_gen
  - name: retryable_writes_jscore_stepdown_passthrough_gen
    distros:
    - amazon2023.0-large
  - name: .read_only
  - name: .rollbackfuzzer
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: session_jscore_passthrough
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: sharding_api_version_jscore_passthrough_gen
  - name: .sharding .txns
  - name: .sharding .common !.multiversion
  - name: .stitch
  - name: .crypt
    distros:
    - amazon2023.0-large
  - name: .publish_crypt
  - name: secondary_reads_passthrough_gen
  - name: server_discovery_and_monitoring_json_test_TG
  - name: .serverless
    distros:
    - amazon2023.0-large
  - name: server_selection_json_test_TG
    distros:
    - amazon2023.0-large
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: amazon2023-arm64
  display_name: Amazon Linux 2023 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.0-arm64-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-amazon2023
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2023
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: aarch64
    packager_distro: amazon2023
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: amazon2023.0-arm64-large
    compile_variant: amazon2023-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.0-arm64-large
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - amazon2023.0-arm64-large
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.multiversion !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2204-arm64-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-amazon2023-arm64
  display_name: "Enterprise Amazon Linux 2023 arm64"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.0-arm64-small
  expansions:
    additional_package_targets: archive-mongocryptd archive-mongocryptd-debug archive-mh archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-amazon2023
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2023
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    crypt_task_compile_flags: SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique" CCFLAGS="-fno-gnu-unique"
    # TODO BUILD-13887 should fix uses_pykmip incompatibility.
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,uses_pykmip,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: true
    multiversion_platform: amazon2023
    multiversion_edition: enterprise
    multiversion_architecture: aarch64
    packager_script: packager_enterprise.py
    packager_arch: aarch64
    packager_distro: amazon2023
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-amazon2023-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.0-arm64-large
  - name: test_api_version_compatibility
  - name: .aggfuzzer !.feature_flag_guarded !.multiversion
  - name: .aggregation !.feature_flag_guarded
  - name: audit
  - name: .auth !.multiversion
  - name: .causally_consistent !.sharding
  - name: .change_streams
  - name: .change_stream_fuzzer
  - name: .misc_js
  - name: .concurrency !.large !.ubsan !.no_txns
  - name: .concurrency .large !.ubsan !.no_txns
    distros:
    - amazon2023.0-arm64-large
  - name: .config_fuzzer !.large
  - name: .config_fuzzer .large
    distros:
    - amazon2023.0-arm64-large
  - name: disk_wiredtiger
  - name: .encrypt
  - name: idl_tests
  - name: initial_sync_fuzzer_gen
  - name: jsCore
    distros:
    - amazon2023.0-arm64-large
  - name: .jscore .common !jsCore !.feature_flag_guarded
  - name: jsCore_min_batch_repeat_queries_ese_gsm
  - name: jsCore_txns_large_txns_format
  - name: json_schema
  - name: .jstestfuzz !.flow_control  # Flow control jstestfuzz take longer.
  - name: libunwind_tests
  - name: .multi_shard
  - name: multi_stmt_txn_jscore_passthrough_with_migration_gen
  - name: .query_fuzzer
  - name: .read_write_concern .large
    distros:
    - amazon2023.0-arm64-large
  - name: .read_write_concern !.large
  - name: .replica_sets !.encrypt !.auth
    distros:
    - amazon2023.0-arm64-large
  - name: replica_sets_api_version_jscore_passthrough_gen
  - name: replica_sets_reconfig_jscore_passthrough_gen
  - name: retryable_writes_jscore_passthrough_gen
  - name: retryable_writes_jscore_stepdown_passthrough_gen
    distros:
    - amazon2023.0-arm64-large
  - name: .read_only
  - name: .rollbackfuzzer
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: session_jscore_passthrough
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: sharding_api_version_jscore_passthrough_gen
  - name: .sharding .txns
  - name: .sharding .common !.multiversion
  - name: .stitch
  - name: .crypt
    distros:
    - amazon2023.0-arm64-large
  - name: .publish_crypt
  - name: secondary_reads_passthrough_gen
  - name: server_discovery_and_monitoring_json_test_TG
  - name: .serverless
    distros:
    - amazon2023.0-arm64-large
  - name: server_selection_json_test_TG
    distros:
    - amazon2023.0-arm64-large
  - name: test_packages
    distros:
    - ubuntu2204-arm64-large
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: debian11
  display_name: Debian 11
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - debian11-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-debian11
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=debian11
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: >-
      --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    multiversion_platform: debian11
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: debian11
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: debian11-large
    compile_variant: debian11
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - debian11-large
  - name: .aggfuzzer .common !.feature_flag_guarded
  - name: aggregation !.feature_flag_guarded
  - name: aggregation_auth
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common !.decimal !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: multiversion_gen
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: .sharding .common !.csrs !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  # TODO SERVER-89541 Remove ocsp tag once oscrypto gets updated
  - name: .ssl !.ocsp
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-debian11-64
  display_name: Enterprise Debian 11
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - debian11-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-debian11
    compile_flags: >-
      --ssl MONGO_DISTMOD=debian11
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    multiversion_platform: debian11
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: debian11
    repo_edition: enterprise
    scons_cache_scope: shared
    large_distro_name: debian11-large
    compile_variant: enterprise-debian11-64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - debian11-large
  - name: .aggfuzzer .common !.feature_flag_guarded
  - name: audit
  - name: causally_consistent_jscore_txns_passthrough
  # TODO SERVER-89541 Remove ocsp tag once oscrypto gets updated
  - name: .encrypt !.replica_sets !.aggregation !.sharding !.jscore !.ocsp
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: sasl
  - name: sharding_auth_audit_gen
  - name: .stitch
  - name: .crypt
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: debian12
  display_name: Debian 12
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - debian12-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-debian12
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=debian12
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: >-
      --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    multiversion_platform: debian12
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: debian12
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: debian12-large
    compile_variant: debian12
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - debian12-large
  - name: .aggfuzzer .common !.feature_flag_guarded !.multiversion
  - name: aggregation !.feature_flag_guarded
  - name: aggregation_auth
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common !.decimal !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: .sharding .common !.csrs !.encrypt !.multiversion
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  # TODO SERVER-89541 Remove ocsp tag once oscrypto gets updated
  - name: .ssl !.ocsp
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-debian12-64
  display_name: Enterprise Debian 12
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - debian12-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-debian12
    compile_flags: >-
      --ssl MONGO_DISTMOD=debian12
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    multiversion_platform: debian12
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: debian12
    repo_edition: enterprise
    scons_cache_scope: shared
    large_distro_name: debian12-large
    compile_variant: enterprise-debian12-64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - debian12-large
  - name: .aggfuzzer .common !.feature_flag_guarded !.multiversion
  - name: audit
  - name: causally_consistent_jscore_txns_passthrough
  # TODO SERVER-89541 Remove ocsp tag once oscrypto gets updated
  - name: .encrypt !.replica_sets !.aggregation !.sharding !.jscore !.ocsp
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: sasl
  - name: sharding_auth_audit_gen
  - name: .stitch
  - name: .crypt
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: rhel70
  display_name: RHEL 7.0
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel70-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-rhel70
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel70
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    multiversion_platform: rhel70
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: rhel70
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: rhel70
    compile_variant: rhel70
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel70
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - rhel70
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: multiversion_gen
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: selinux_rhel7_org
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

  # This variant compiles on RHEL 7.0 and runs tests on RHEL 7.6
- name: rhel76_compile_rhel70
  display_name: RHEL 7.0/7.6 Cross-ABI
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel76-test
  expansions:
    test_flags: --excludeWithAnyTags=requires_latch_analyzer --enableEnterpriseTests=off
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel70
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    compile_variant: rhel76_compile_rhel70
  tasks:
  - name: compile_and_archive_dist_test_then_package_TG
    distros:
    - rhel70
  - name: .ssl
  - name: jsCore
  - name: external_auth
  - name: generate_buildid_to_debug_symbols_mapping

- name: ubi8
  display_name: "UBI 8"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubi8
  expansions:
    resmoke_jobs_factor: 1
    disable_shared_scons_cache: true
    compile_flags: >-
      MONGO_DISTMOD=rhel80
      --opt=on
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    tooltags: ""
    build_mongoreplay: true
    test_flags: >-
      --excludeWithAnyTags=requires_os_access,requires_latch_analyzer
      --enableEnterpriseTests=off
    compile_variant: ubi8
  tasks:
  - name: compile_and_archive_dist_test_then_package_TG
    distros:
    - rhel80-large
  - name: jsCore
  - name: sharding_gen
  - name: replica_sets_gen
  - name: generate_buildid_to_debug_symbols_mapping
    distros:
    - rhel80-large

- name: rhel8
  display_name: RHEL 8
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel80-build
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-rhel80
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel80
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    multiversion_platform: rhel80
    multiversion_platform_50_or_later: rhel8
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: rhel80
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: rhel80-build
    compile_variant: rhel8
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel80-build
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - rhel80-build
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: multiversion_gen
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: selinux_rhel8_org
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-rhel-8-64-bit
  display_name: "Enterprise RHEL 8"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel80-small
  expansions: &enterprise-rhel-8-64-bit-expansions
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-rhel80
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel80
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CFLAGS="-fno-gnu-unique"
    multiversion_platform: rhel80
    multiversion_platform_50_or_later: rhel8
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: rhel80
    repo_edition: enterprise
    scons_cache_scope: shared
    jstestfuzz_num_generated_files: 40
    jstestfuzz_concurrent_num_files: 10
    target_resmoke_time: 10
    max_sub_suites: 3
    large_distro_name: rhel80-medium
    compile_variant: enterprise-rhel-8-64-bit
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel80-large
  - name: compile_integration_and_test_parallel_stream_TG
    distros:
    - rhel80-large
  - name: .aggfuzzer !.feature_flag_guarded
  - name: .aggregation !.feature_flag_guarded
  - name: audit
  - name: .auth
  - name: unittest_shell_hang_analyzer_gen
  - name: .causally_consistent !.sharding
  - name: .change_streams
  - name: .change_stream_fuzzer
  - name: .misc_js
  - name: .concurrency !.large !.ubsan !.no_txns
  - name: .concurrency .large !.ubsan !.no_txns
    distros:
    - rhel80-medium
  - name: disk_wiredtiger
  - name: .encrypt
  - name: idl_tests
  - name: initial_sync_fuzzer_gen
  - name: .jscore .common
  - name: jsCore_min_batch_repeat_queries_ese_gsm
  - name: jsCore_txns_large_txns_format
  - name: json_schema
  - name: .jstestfuzz !.flow_control  # Flow control jstestfuzz take longer.
  - name: libunwind_tests
  - name: .multi_shard
  - name: multi_stmt_txn_jscore_passthrough_with_migration_gen
  - name: multiversion_gen
  - name: .query_fuzzer
  - name: .random_multiversion_ds
  - name: .read_write_concern .large
    distros:
    - rhel80-medium
  - name: .read_write_concern !.large
  - name: .replica_sets !.encrypt !.auth
    distros:
    - rhel80-medium
  - name: replica_sets_api_version_jscore_passthrough_gen
  - name: replica_sets_reconfig_jscore_passthrough_gen
  - name: replica_sets_reconfig_jscore_stepdown_passthrough_gen
    distros:
    - rhel80-medium
  - name: replica_sets_reconfig_kill_primary_jscore_passthrough_gen
    distros:
    - rhel80-medium
  - name: .resharding_fuzzer
  - name: retryable_writes_jscore_passthrough_gen
  - name: retryable_writes_jscore_stepdown_passthrough_gen
    distros:
    - rhel80-medium
  - name: .read_only
  - name: .rollbackfuzzer
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: session_jscore_passthrough
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: sharding_api_version_jscore_passthrough_gen
  - name: .sharding .txns
  - name: .sharding .common
  - name: .stitch
  - name: .crypt
    distros:
    - rhel80-large
  - name: .publish_crypt
  - name: .updatefuzzer
  - name: secondary_reads_passthrough_gen
  - name: server_discovery_and_monitoring_json_test_TG
    distros:
    - rhel80-large
  - name: server_selection_json_test_TG
    distros:
    - rhel80-large
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
  - name: selinux_rhel8_enterprise
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: rhel-8-arm64
  display_name: RHEL 8 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel82-arm64-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-rhel82
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel82
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_increased_memlock_limits,requires_latch_analyzer --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: aarch64
    packager_distro: rhel82
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: rhel82-arm64-large
    compile_variant: rhel-8-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel82-arm64-large
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - rhel82-arm64-large
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.multiversion !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-rhel-8-arm64
  display_name: "Enterprise RHEL 8 arm64"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel82-arm64-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-rhel82
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel82
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic
      -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: aarch64
    packager_distro: rhel82
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-rhel-8-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel82-arm64-large
  - name: .aggfuzzer !.multiversion !.feature_flag_guarded
  - name: audit
  - name: auth_audit_gen
  - name: auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .encrypt !.sharding !.replica_sets !.aggregation !.jscore
  - name: external_auth
  - name: external_auth_aws
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: jsCore_txns_large_txns_format
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: .replica_sets .multi_oplog
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: sharding_auth_audit_gen
  - name: .stitch
  - name: .crypt
    distros:
    - rhel82-arm64-large
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: rhel90
  display_name: RHEL 9.0
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel90-build
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-rhel90
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel90
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: >-
      --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    multiversion_platform: rhel90
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: rhel90
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: rhel90-build
    compile_variant: rhel90
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel90-build
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - rhel90-build
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common !.multiversion
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.multiversion !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: selinux_rhel9_org
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-rhel-90-64-bit
  display_name: "Enterprise RHEL 9.0"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel90-small
  expansions: &enterprise-rhel-90-64-bit-expansions
    additional_package_targets: archive-mongocryptd archive-mongocryptd-debug archive-mh archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-rhel90
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel90
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: >-
      --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique" CCFLAGS="-fno-gnu-unique"
    multiversion_platform: rhel90
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: rhel90
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-rhel-90-64-bit
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel90-large
  - name: compile_build_tools_next_TG
    distros:
    - rhel90-large
  - name: .aggfuzzer !.feature_flag_guarded !.multiversion
  - name: audit
  - name: auth_audit_gen
  - name: auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .config_fuzzer !.large
  - name: .config_fuzzer .large
    distros:
    - rhel90-large
  - name: .encrypt !.sharding !.replica_sets !.aggregation !.jscore
  - name: external_auth
  - name: external_auth_aws
  - name: .jscore .common !.decimal !.sharding
  - name: jsCore_txns_large_txns_format
  - name: .jstestfuzz .common
  - name: libunwind_tests
  - name: .logical_session_cache .one_sec
  - name: .ocsp
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: .replica_sets .multi_oplog
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: sharding_auth_audit_gen
  - name: .stitch
  - name: .crypt
  - name: .publish_crypt
  - name: unittest_shell_hang_analyzer_gen
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
  - name: selinux_rhel9_enterprise
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping


- name: rhel90-arm64
  display_name: RHEL 9.0 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel90-arm64-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-rhel90
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel90
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: aarch64
    packager_distro: rhel90
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: rhel90-arm64-large
    compile_variant: rhel90-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel90-arm64-large
  - name: aggregation
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
    distros:
    - rhel90-arm64-large
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.multiversion !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2204-arm64-small
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-rhel-90-arm64
  display_name: "Enterprise RHEL 9.0 arm64"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel90-arm64-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-rhel90
    compile_flags: >-
      --ssl MONGO_DISTMOD=rhel90
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic
      -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: aarch64
    packager_distro: rhel90
    repo_edition: enterprise
    scons_cache_scope: shared
    large_distro_name: rhel90-arm64-large
    compile_variant: enterprise-rhel-90-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - rhel90-arm64-large
  - name: .aggfuzzer !.feature_flag_guarded !.multiversion
  - name: audit
  - name: auth_audit_gen
  - name: auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .encrypt !.sharding !.replica_sets !.aggregation !.jscore
  - name: external_auth
  - name: external_auth_aws
  - name: .jscore .common !.decimal !.sharding
  - name: jsCore_txns_large_txns_format
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: .replica_sets .multi_oplog
  - name: sasl
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: sharding_auth_audit_gen
  - name: sharding_auth_gen
  - name: .stitch
  - name: .crypt
    distros:
    - rhel90-arm64-large
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu2204-arm64-small
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: suse12
  display_name: SUSE 12
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - suse12-sp5-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-suse12
    # TODO: BUILD-16601
    # Below we are switching to gold linker because suse12 does not have
    # a llvm deployment in the toolchain because of issue in BUILD-16601
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=suse12
      -j$(echo $(grep -c ^processor /proc/cpuinfo) / 2 | bc)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --linker=gold
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_increased_memlock_limits,requires_latch_analyzer --enableEnterpriseTests=off
    multiversion_platform: suse12
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: suse12
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: suse12-sp5-large
    compile_variant: suse12
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - suse12-sp5-large
  - name: .aggfuzzer .common !.feature_flag_guarded
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common !.large
  - name: .concurrency .common .large
    distros:
    - suse12-sp5-large
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common !.decimal !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: multiversion_gen
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-suse12-64
  display_name: Enterprise SLES 12
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - suse12-sp5-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-suse12
    # TODO: BUILD-16601
    # Below we are switching to gold linker because suse12 does not have
    # a llvm deployment in the toolchain because of issue in BUILD-16601
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=suse12
      -j$(echo $(grep -c ^processor /proc/cpuinfo) / 2 | bc)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --linker=gold
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    multiversion_platform: suse12
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: suse12
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-suse12-64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - suse12-sp5-large
  - name: .aggfuzzer .common !.feature_flag_guarded
  - name: audit
  - name: causally_consistent_jscore_txns_passthrough
  - name: .encrypt !.replica_sets !.aggregation !.sharding !.jscore
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: sasl
  - name: sharding_auth_audit_gen
  - name: .stitch
  - name: .crypt
    distros:
    - suse12-sp5-large
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-suse15-64
  display_name: Enterprise SLES 15
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - suse15-test
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-suse15
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=suse15
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: suse15
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-suse15-64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - suse15-build
  - name: .aggfuzzer .common !.multiversion !.feature_flag_guarded
  - name: audit
  - name: causally_consistent_jscore_txns_passthrough
  - name: .encrypt !.replica_sets !.aggregation !.sharding !.jscore
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: sasl
  - name: sharding_auth_audit_gen
  - name: .stitch
  - name: .crypt
  - name: .publish_crypt
  - name: .publish
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: generate_buildid_to_debug_symbols_mapping

- name: suse15
  display_name: SUSE 15
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - suse15-test
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-suse15
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=suse15
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_increased_memlock_limits,requires_latch_analyzer --enableEnterpriseTests=off
    multiversion_platform: suse15
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: suse15
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: suse15-build
    compile_variant: suse15
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - suse15-build
  - name: .aggfuzzer .common !.multiversion !.feature_flag_guarded
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common !.decimal !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: multiversion_gen
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.multiversion !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: .publish
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-ubuntu1804-64
  display_name: Jepsen Tests on Enterprise Ubuntu 18.04
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu1804-small
  expansions:
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=ubuntu1804
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    scons_cache_scope: shared
    large_distro_name: ubuntu1804-large
    compile_variant: enterprise-ubuntu1804-64
  tasks:
  - name: compile_and_archive_dist_test_TG
    distros:
    - ubuntu1804-large
  - name: .jepsen
    distros:
    - ubuntu1804-large

- &ubuntu2204-template
  name: &ubuntu2204 ubuntu2204
  display_name: Ubuntu 22.04
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu2204-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-ubuntu2204
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=ubuntu2204
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_increased_memlock_limits,requires_latch_analyzer --enableEnterpriseTests=off
    multiversion_platform: ubuntu2204
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: ubuntu2204
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: ubuntu2204-large
    compile_variant: ubuntu2204
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - ubuntu2204-large
  - name: .aggfuzzer .common !.multiversion !.feature_flag_guarded
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: libunwind_tests
  - name: .logical_session_cache .one_sec
  # - name: multiversion_gen
  - name: replica_sets_gen
  - name: replica_sets_jscore_passthrough
  - name: .sharding .txns
  - name: sharding_gen
  - name: sharding_jscore_passthrough
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- <<: *ubuntu2204-template
  name: ubuntu2204-powercycle
  display_name: Ubuntu 22.04 Powercycle
  depends_on:
  - name: archive_dist_test_debug
    variant: *ubuntu2204
  tasks:
  - name: .powercycle

- name: ubuntu2004
  display_name: Ubuntu 20.04
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu2004-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-ubuntu2004
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=ubuntu2004
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    multiversion_platform: ubuntu2004
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: ubuntu2004
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: ubuntu2004-large
    compile_variant: ubuntu2004
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - ubuntu2004-large
  - name: .aggfuzzer .common !.multiversion !.feature_flag_guarded
  - name: aggregation !.feature_flag_guarded
  - name: .auth !.audit !.multiversion
  - name: sharding_auth_gen
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: disk_wiredtiger
  - name: .jscore .common
  - name: .jstestfuzz .common
  - name: libunwind_tests
  - name: .logical_session_cache .one_sec
  # - name: multiversion_gen
  - name: replica_sets_gen
  - name: replica_sets_jscore_passthrough
  - name: .sharding .txns
  - name: sharding_gen
  - name: sharding_jscore_passthrough
  - name: .ssl
  - name: .stitch
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-ubuntu2004-64
  display_name: Enterprise Ubuntu 20.04
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu2004-small
  stepback: false
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-ubuntu2004
    compile_flags: >-
      --ssl MONGO_DISTMOD=ubuntu2004
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    multiversion_platform: ubuntu2004
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: ubuntu2004
    repo_edition: enterprise
    scons_cache_scope: shared
    large_distro_name: ubuntu2004-large
    # TODO SERVER-64479 remove external_auth_jobs_max once resolved
    external_auth_jobs_max: 1
    compile_variant: enterprise-ubuntu2004-64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - ubuntu2004-large
  - name: .crypt
  - name: .publish_crypt
  - name: .aggfuzzer .common !.multiversion !.feature_flag_guarded
  - name: audit
  - name: causally_consistent_jscore_txns_passthrough
  - name: .encrypt !.aggregation !.replica_sets !.sharding !.jscore
  - name: external_auth
  - name: external_auth_aws
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: jsCore_auth
  - name: .jstestfuzz .common
  - name: libunwind_tests
  - name: .logical_session_cache .one_sec
  - name: .ocsp
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: sasl
  - name: sharding_auth_audit_gen
  - name: test_packages
    distros:
    - ubuntu2004-package
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-ubuntu2204-64
  display_name: Enterprise Ubuntu 22.04
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu2204-small
  stepback: false
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-ubuntu2204
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=ubuntu2204
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    multiversion_platform: ubuntu2204
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: ubuntu2204
    repo_edition: enterprise
    scons_cache_scope: shared
    large_distro_name: ubuntu2204-large
    # TODO SERVER-64479 remove external_auth_jobs_max once resolved
    external_auth_jobs_max: 1
    compile_variant: enterprise-ubuntu2204-64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - ubuntu2204-large
  - name: .crypt
  - name: .publish_crypt
  - name: .aggfuzzer .common !.multiversion !.feature_flag_guarded
  - name: audit
  - name: causally_consistent_jscore_txns_passthrough
  - name: .encrypt !.aggregation !.replica_sets !.sharding !.jscore
  - name: external_auth
  - name: external_auth_aws
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: jsCore_auth
  - name: .jstestfuzz .common
  - name: libunwind_tests
  - name: .logical_session_cache .one_sec
  - name: .ocsp
  - name: replica_sets_auth_gen
  - name: replica_sets_jscore_passthrough
  - name: sasl
  - name: sharding_auth_audit_gen
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: enterprise-ubuntu2204-jepsen
  display_name: Jepsen Tests on Enterprise Ubuntu 22.04
  tags: ["bazel_check"]
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
    - ubuntu2204-small
  stepback: false
  expansions:
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=ubuntu2204
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    scons_cache_scope: shared
    large_distro_name: ubuntu2204-large
    compile_variant: enterprise-ubuntu2204-64
  tasks:
    - name: compile_test_and_package_serial_no_unittests_TG
      distros:
        - ubuntu2204-large
    - name: .jepsen_docker
      distros:
        - ubuntu2204-large

- name: enterprise-ubuntu2004-arm64
  display_name: Enterprise Ubuntu 20.04 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu1804-arm64-build
  expansions:
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-ubuntu2004
    compile_flags: >-
      --ssl MONGO_DISTMOD=ubuntu2004
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: >-
      SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique"
      CCFLAGS="-fno-gnu-unique"
    resmoke_jobs_max: 4 # Avoid starting too many mongod's on ARM test servers
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: arm64
    packager_distro: ubuntu2004
    repo_edition: enterprise
    multiversion_platform: ubuntu2004
    multiversion_architecture: aarch64
    multiversion_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-ubuntu2004-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
  - name: aggregation !.feature_flag_guarded
  - name: aggregation_wildcard_fuzzer_gen
  - name: .auth !.audit !.multiversion !.jscore
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: fle
  - name: .jscore .common !.auth !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: sharding_gen
  - name: sharding_jscore_passthrough
  - name: .ssl
  - name: .stitch
  - name: .crypt
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: ubuntu2004-arm64
  display_name: Ubuntu 20.04 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu1804-arm64-build
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-ubuntu2004
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=ubuntu2004
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    resmoke_jobs_max: 8 # Avoid starting too many mongod's on ARM test servers
    has_packages: true
    packager_script: packager.py
    packager_arch: arm64
    packager_distro: ubuntu2004
    repo_edition: org
    multiversion_platform: ubuntu2004
    multiversion_architecture: aarch64
    multiversion_edition: targeted
    scons_cache_scope: shared
    compile_variant: ubuntu2004-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
  - name: jsCore
  - name: replica_sets_jscore_passthrough
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping


- name: enterprise-ubuntu2204-arm64
  display_name: Enterprise Ubuntu 22.04 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu2204-arm64-large
  expansions:
    additional_package_targets: archive-mongocryptd archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-ubuntu2204
    compile_flags: >-
      --ssl MONGO_DISTMOD=ubuntu2204
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: >-
      --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
    crypt_task_compile_flags: SHLINKFLAGS_EXTRA="-Wl,-Bsymbolic -Wl,--no-gnu-unique" CCFLAGS="-fno-gnu-unique"
    resmoke_jobs_max: 4 # Avoid starting too many mongod's on ARM test servers
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: arm64
    packager_distro: ubuntu2204
    repo_edition: enterprise
    multiversion_platform: ubuntu2204
    multiversion_architecture: aarch64
    multiversion_edition: enterprise
    scons_cache_scope: shared
    compile_variant: enterprise-ubuntu2204-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
  - name: aggregation !.feature_flag_guarded
  - name: aggregation_wildcard_fuzzer_gen
  - name: .auth !.audit !.multiversion !.jscore
  - name: sharding_auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
  - name: .concurrency .common
  - name: concurrency_replication_causal_consistency_gen
  - name: fle
  - name: .jscore .common !.auth !.feature_flag_guarded
  - name: .jstestfuzz .common
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common
  - name: .sharding .txns
  - name: sharding_gen
  - name: sharding_jscore_passthrough
  - name: .ssl
  - name: .stitch
  - name: .crypt
  - name: .publish_crypt
  - name: test_packages
    distros:
    - ubuntu2204-arm64-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: ubuntu2204-arm64
  display_name: Ubuntu 22.04 arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - ubuntu2204-arm64-large
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-ubuntu2204
    compile_flags: >-
      --ssl MONGO_DISTMOD=ubuntu2204
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --modules=
    test_flags: >-
      --excludeWithAnyTags=requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    resmoke_jobs_max: 8 # Avoid starting too many mongod's on ARM test servers
    has_packages: true
    packager_script: packager.py
    packager_arch: arm64
    packager_distro: ubuntu2204
    repo_edition: org
    multiversion_platform: ubuntu2204
    multiversion_architecture: aarch64
    multiversion_edition: targeted
    scons_cache_scope: shared
    compile_variant: ubuntu2204-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
  - name: jsCore
  - name: replica_sets_jscore_passthrough
  - name: test_packages
    distros:
    - ubuntu2204-arm64-large
  - name: .publish
  - name: generate_buildid_to_debug_symbols_mapping

- name: windows
  display_name: Windows
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - windows-vsCurrent-small
  expansions:
    additional_package_targets: msi
    exe: ".exe"
    push_path: windows
    push_bucket: downloads.mongodb.org
    push_name: windows
    push_arch: x86_64
    multiversion_platform: windows_x86_64-2008plus-ssl
    multiversion_platform_42_or_later: windows_x86_64-2012plus
    multiversion_platform_44_or_later: windows
    multiversion_edition: base
    content_type: application/zip
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=windows
      -j$(bc <<< "$(grep -c '^processor' /proc/cpuinfo) / 1.5")
      --win-version-min=win10
      --modules=
    num_scons_link_jobs_available: 0.25
    python: '/cygdrive/c/python/python37/python.exe'
    ext: zip
    scons_cache_scope: shared
    large_distro_name: windows-vsCurrent-large
    test_flags: &windows_common_test_excludes --excludeWithAnyTags=incompatible_with_windows_tls,requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    compile_variant: windows
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - windows-vsCurrent-large
  - name: .aggfuzzer !.feature_flag_guarded
  - name: .aggregation !.auth !.encrypt !.unwind !.feature_flag_guarded
  - name: auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
    # Some concurrency workloads require a lot of memory, so we use machines
    # with more RAM for these suites.
  - name: .concurrency !.ubsan !.no_txns !.kill_terminate !.common
    distros:
    - windows-vsCurrent-large
  - name: .concurrency .common
  - name: disk_wiredtiger
  - name: .jscore .common !.auth !.feature_flag_guarded
  - name: json_schema
  - name: .jstestfuzz !.initsync !.flow_control !.stepdowns
  - name: multiversion_gen
  - name: multiversion_auth_gen
  - name: .query_fuzzer
  - name: .read_write_concern
  - name: replica_sets_gen
  - name: replica_sets_jscore_passthrough_gen
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.encrypt
  - name: sharding_max_mirroring_opportunistic_secondary_targeting_gen
  - name: .ssl
  - name: .stitch
  - name: .updatefuzzer
  - name: push

- name: enterprise-windows
  display_name: "Enterprise Windows"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - windows-vsCurrent-small
  expansions:
    exe: ".exe"
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      msi
      archive-mh
      archive-mh-debug
    content_type: application/zip
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=windows
      CPPPATH="c:/sasl/include"
      LIBPATH="c:/sasl/lib"
      -j$(bc <<< "$(grep -c '^processor' /proc/cpuinfo) / 1.5")
      --win-version-min=win10
    num_scons_link_jobs_available: 0.25
    python: '/cygdrive/c/python/python37/python.exe'
    ext: zip
    scons_cache_scope: shared
    multiversion_platform: windows
    multiversion_edition: enterprise
    jstestfuzz_num_generated_files: 35
    target_resmoke_time: 20
    max_sub_suites: 3
    large_distro_name: windows-vsCurrent-large
    push_path: windows
    push_bucket: downloads.10gen.com
    push_name: windows
    push_arch: x86_64-enterprise
    test_flags: *windows_common_test_excludes
    exec_timeout_secs: 14400 # 3 hour timeout
    compile_variant: enterprise-windows
  tasks:
  - name: compile_test_and_package_serial_TG
    distros:
    - windows-vsCurrent-large
  - name: compile_test_and_package_parallel_unittest_stream_TG
    distros:
    - windows-vsCurrent-large
  - name: .aggfuzzer !.feature_flag_guarded
  - name: .aggregation !.auth !.encrypt !.unwind !.feature_flag_guarded
  - name: auth_gen
  - name: causally_consistent_jscore_txns_passthrough
  - name: .misc_js
    # Some concurrency workloads require a lot of memory, so we use machines
    # with more RAM for these suites.
  - name: .concurrency !.ubsan !.no_txns !.kill_terminate !.common
    distros:
    - windows-vsCurrent-large
  - name: .concurrency .common
  - name: .crypt
    distros:
    - windows-vsCurrent-large
  - name: .publish_crypt
  - name: disk_wiredtiger
  - name: .jscore .common !.auth !.feature_flag_guarded
  - name: json_schema
  - name: .jstestfuzz !.initsync !.flow_control !.stepdowns
  - name: multiversion_gen
  - name: multiversion_auth_gen
  - name: .query_fuzzer
  - name: .read_write_concern
  - name: replica_sets_gen
  - name: replica_sets_jscore_passthrough
  - name: .sharding .jscore !.wo_snapshot !.multi_stmt
  - name: .sharding .txns
  - name: .sharding .common !.csrs !.gcm
  - name: .ssl
  - name: .stitch
  - name: .updatefuzzer
  - name: push

  ###########################################
  #           macOS buildvariants           #
  ###########################################
- name: macos
  display_name: macOS
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - macos-1100
  expansions:
    test_flags: --excludeWithAnyTags=incompatible_with_macos,requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    push_path: osx
    push_bucket: downloads.mongodb.org
    push_name: macos
    push_arch: x86_64
    compile_env: DEVELOPER_DIR=/Applications/Xcode13.app
    compile_flags: >-
      --ssl
      -j$(sysctl -n hw.logicalcpu)
      --libc++
      --variables-files=etc/scons/xcode_macosx.vars
      --modules=
    resmoke_jobs_max: 6
    compile_variant: macos
  tasks:
  - name: compile_test_and_package_serial_TG
  - name: compile_test_and_package_parallel_unittest_stream_TG
  - name: compile_build_tools_next_TG
  - name: aggregation
  - name: auth_gen
  - name: change_streams
  - name: .misc_js
  - name: disk_wiredtiger
  - name: .jscore .common !.auth !.sharding !.feature_flag_guarded
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common !.auth
  - name: .ssl
  - name: push

- name: macos-arm64
  display_name: macOS arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - macos-1100-arm64
  expansions:
    test_flags: --excludeWithAnyTags=incompatible_with_macos,requires_external_data_source,requires_latch_analyzer --enableEnterpriseTests=off
    push_path: osx
    push_bucket: downloads.mongodb.org
    push_name: macos
    push_arch: arm64
    compile_env: DEVELOPER_DIR=/Applications/Xcode13.app
    compile_flags: >-
      --ssl
      -j$(sysctl -n hw.logicalcpu)
      --libc++
      --variables-files=etc/scons/xcode_macosx_arm.vars
      --modules=
    resmoke_jobs_max: 6
    compile_variant: macos-arm64
  tasks:
  - name: compile_test_and_package_serial_TG
  - name: compile_test_and_package_parallel_unittest_stream_TG
  - name: compile_build_tools_next_TG
  - name: aggregation
  - name: auth_gen
  - name: change_streams
  - name: .misc_js
  - name: disk_wiredtiger
  - name: .jscore .common !.auth !.sharding !.feature_flag_guarded
  - name: .logical_session_cache .one_sec
  - name: replica_sets_gen
  - name: .replica_sets .common !.auth
  - name: .ssl
  - name: push

- name: enterprise-macos
  display_name: Enterprise macOS
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - macos-1100
  expansions:
    test_flags: --excludeWithAnyTags=incompatible_with_macos,requires_gcm,requires_external_data_source,requires_latch_analyzer
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: osx
    push_bucket: downloads.10gen.com
    push_name: macos
    push_arch: x86_64-enterprise
    compile_env: DEVELOPER_DIR=/Applications/Xcode13.app
    compile_flags: >-
      --ssl
      -j$(sysctl -n hw.logicalcpu)
      --libc++
      --variables-files=etc/scons/xcode_macosx.vars
    resmoke_jobs_max: 6
    compile_variant: enterprise-macos
  tasks:
  - name: compile_test_and_package_serial_TG
  - name: compile_test_and_package_parallel_unittest_stream_TG
  - name: compile_build_tools_next_TG
  - name: audit
  - name: auth_audit_gen
  - name: .encrypt !.replica_sets !.sharding !.aggregation !.jscore
  - name: .logical_session_cache .one_sec
  - name: replica_sets_auth_gen
  - name: sasl
  - name: push
  - name: .crypt
  - name: .publish_crypt

- name: enterprise-macos-arm64
  display_name: Enterprise macOS arm64
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - macos-1100-arm64
  expansions:
    test_flags: --excludeWithAnyTags=incompatible_with_macos,requires_gcm,requires_external_data_source,requires_latch_analyzer
    additional_package_targets: >-
      archive-mongocryptd
      archive-mongocryptd-debug
      archive-mh
      archive-mh-debug
    push_path: osx
    push_bucket: downloads.10gen.com
    push_name: macos
    push_arch: arm64-enterprise
    compile_env: DEVELOPER_DIR=/Applications/Xcode13.app
    compile_flags: >-
      --ssl
      -j$(sysctl -n hw.logicalcpu)
      --libc++
      --variables-files=etc/scons/xcode_macosx_arm.vars
    resmoke_jobs_max: 6
    compile_variant: enterprise-macos-arm64
  tasks:
  - name: compile_test_and_package_serial_TG
  - name: compile_test_and_package_parallel_unittest_stream_TG
  - name: compile_build_tools_next_TG
  - name: audit
  - name: auth_audit_gen
  - name: fle
  - name: fle2
  - name: .jscore .common !.decimal !.sharding !.feature_flag_guarded
  - name: .logical_session_cache .one_sec
  - name: replica_sets_auth_gen
  - name: sasl
  - name: push
  - name: .crypt
  - name: .publish_crypt

- name: enterprise-rhel-8-arm64-grpc
  display_name: "Enterprise RHEL 8 arm64 GRPC"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - rhel82-arm64-large
  stepback: false
  expansions:
    test_flags: --excludeWithAnyTags=requires_latch_analyzer
    compile_flags: >-
      --ssl
      --dbg=on
      MONGO_DISTMOD=rhel80
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
      --link-model=dynamic
      ENABLE_GRPC_BUILD=1
    compile_variant: enterprise-rhel-8-arm64-grpc
    scons_cache_scope: shared
  tasks:
    - name: compile_test_and_package_parallel_unittest_stream_TG
    - name: compile_test_and_package_parallel_core_stream_TG
    - name: compile_test_and_package_parallel_dbtest_stream_TG

# This task is responsible for creating a AL2023 x86 server binary candidate for 10gen/mongot.
# A project trigger defined on 10gen/mongot runs when this variant succeeds, to check if the resulting
# binary candidate passes their tests and is therefore safe to use in their pre-commit integration tests.
- name: amazon-linux-2023-x86-mongot-integration-cron-only
  display_name: "AL2023 x86 mongot integration tasks cron only"
  cron: "0 */4 * * *" # Run these tasks every 4 hours
  patchable: false
  run_on:
  - amazon2023.0-small
  expansions:
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2023
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: false
    multiversion_platform: amazon2023
    multiversion_edition: enterprise
    multiversion_architecture: x86_64
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: amazon2023
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: amazon-linux-2023-x86-mongot-integration-cron-only
    last_green_candidate: true
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.0-large
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl

# This task is responsible for creating a AL2023 arm64 server binary candidate for 10gen/mongot.
# A project trigger defined on 10gen/mongot runs when this variant succeeds, to check if the resulting
# binary candidate passes their tests and is therefore safe to use in their pre-commit integration tests.
- name: amazon2023-arm64-mongot-integration-cron-only
  display_name: "AL2023 arm64 mongot integration tasks cron only"
  cron: "0 */4 * * *" # Run these tasks every 4 hours
  patchable: false
  run_on:
  - amazon2023.0-arm64-small
  expansions:
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2023
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: >-
      --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    has_packages: false
    multiversion_platform: amazon2023
    multiversion_edition: enterprise
    multiversion_architecture: aarch64
    packager_script: packager_enterprise.py
    packager_arch: aarch64
    packager_distro: amazon2023
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: amazon2023-arm64-mongot-integration-cron-only
    last_green_candidate: true
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.0-arm64-large
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl

# This task is responsible for creating a AL2 arm64 server binary candidate for 10gen/mongot.
# A project trigger defined on 10gen/mongot runs when this variant succeeds, to check if the resulting
# binary candidate passes their tests and is therefore safe to use in their pre-commit integration tests.
- name: amazon-linux2-arm64-mongot-integration-cron-only
  display_name: "AL2 arm64 mongot integration tasks cron only"
  cron: "0 */4 * * *" # Run these tasks every 4 hours
  patchable: false
  run_on:
  - amazon2-arm64-small
  stepback: true
  expansions:
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    scons_cache_scope: shared
    scons_cache_mode: all
    has_packages: false
    jstestfuzz_num_generated_files: 40
    jstestfuzz_concurrent_num_files: 10
    target_resmoke_time: 10
    max_sub_suites: 5
    idle_timeout_factor: 1.5
    exec_timeout_factor: 1.5
    compile_variant: amazon-linux2-arm64-mongot-integration-cron-only
    last_green_candidate: true
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-arm64-large
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl

# This task is responsible for creating a AL2 x86 server binary candidate for 10gen/mongot.
# A project trigger defined on 10gen/mongot runs when this variant succeeds, to check if the resulting
# binary candidate passes their tests and is therefore safe to use in their pre-commit integration tests
- name: amazon2-x86-mongot-integration-cron-only
  display_name: "AL2 x86 mongot integration tasks cron only"
  cron: "0 */4 * * *" # Run these tasks every 4 hours
  patchable: false
  run_on:
  - amazon2-large
  expansions:
    compile_flags: >-
      --ssl
      MONGO_DISTMOD=amazon2
      -j$(grep -c ^processor /proc/cpuinfo)
      --variables-files=etc/scons/mongodbtoolchain_stable_gcc.vars
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: false
    multiversion_platform: amazon2
    multiversion_edition: enterprise
    multiversion_architecture: x86_64
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: amazon2
    repo_edition: enterprise
    scons_cache_scope: shared
    compile_variant: amazon2-x86-mongot-integration-cron-only
    last_green_candidate: true
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-large
  - name: search
  - name: search_auth
  - name: search_pinned_connections_auth
  - name: search_ssl
  - name: vector_search
  - name: vector_search_auth
  - name: vector_search_ssl
