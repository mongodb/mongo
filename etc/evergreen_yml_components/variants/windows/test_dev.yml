# Windows build variants for testing development environments
#
# After the branching variants in this file
# should continue to run on a new rapid release (v7.1, v7.2 etc.)
# and LTS release (v7.0, v6.0 etc.) branch projects

variables:
  # THIS HAS COPIES IN:
  # - etc/evergreen_yml_components/variants/windows/test_dev_master_branch_only.yml
  # - etc/evergreen_yml_components/variants/windows/test_dev.yml
  # ANY MODIFICATIONS HERE SHOULD ALSO BE MADE IN THOSE FILES
  - &windows_compile_variant_dependency
    depends_on:
      - name: archive_dist_test_debug
        variant: &windows_compile_variant_name windows-compile-required
      - name: version_gen
        variant: generate-tasks-for-version
        # This is added because of EVG-18211.
        # Without this we are adding extra dependencies on evergreen and it is causing strain
        omit_generated_tasks: true
    # - name: generate_buildid_to_debug_symbols_mapping
    #   variant: windows-compile-required

  # THIS HAS COPIES IN:
  # - etc/evergreen_yml_components/variants/windows/test_dev_master_branch_only.yml
  # - etc/evergreen_yml_components/variants/windows/test_dev.yml
  # ANY MODIFICATIONS HERE SHOULD ALSO BE MADE IN THOSE FILES
  - &windows_expansions
    compile_variant: *windows_compile_variant_name
    burn_in_tests_build_variant: enterprise-windows-all-feature-flags-required
    exe: ".exe"
    content_type: application/zip
    python: "/cygdrive/c/python/python310/python.exe"
    ext: zip
    multiversion_platform: windows
    multiversion_edition: enterprise
    jstestfuzz_num_generated_files: 35
    target_resmoke_time: 20
    max_sub_suites: 5
    large_distro_name: windows-2022-large
    push_path: windows
    push_bucket: downloads.10gen.com
    push_name: windows
    push_arch: x86_64-enterprise
    test_flags: --excludeWithAnyTags=incompatible_with_windows_tls
    external_auth_jobs_max: 1

buildvariants:
  - name: &windows-compile-required windows-compile-required
    display_name: "! Windows Server 2022 Enterprise Compile"
    tags: ["required", "bazel_check"]
    run_on:
      - windows-2022-xxlarge
    activate: true # These compile variants run on every commit to reduce latency of the auto-reverter.
    expansions:
      exe: ".exe"
      ext: zip
      additional_package_targets: >-
        archive-mongocryptd
        archive-mongocryptd-debug
        msi
      content_type: application/zip
      compile_flags: >-
        --ssl
        MONGO_DISTMOD=windows
        CPPPATH="c:/sasl/include"
        LIBPATH="c:/sasl/lib"
        -j$(bc <<< "$(grep -c '^processor' /proc/cpuinfo) / 1.5")
        --win-version-min=win10
        --use-diagnostic-latches=on
      num_scons_link_jobs_available: 0.1
      python: "/cygdrive/c/python/python310/python.exe"
      scons_cache_scope: shared
      compile_variant: *windows-compile-required
    tasks:
      - name: compile_ninja_quick_TG
      - name: compile_test_parallel_core_stream_TG
      - name: compile_test_parallel_unittest_stream_TG
      - name: compile_test_parallel_dbtest_stream_TG
      - name: compile_build_tools_next_TG
      - name: .release_critical .requires_compile_variant !.requires_large_host !.incompatible_development_variant !.incompatible_windows !.stitch
      - name: .release_critical .requires_compile_variant .requires_large_host !.incompatible_development_variant !.incompatible_windows !.stitch
        distros:
          - windows-2022-xxlarge
      - name: .default .requires_compile_variant !.requires_large_host !.incompatible_development_variant
      - name: .default .requires_compile_variant .requires_large_host !.incompatible_development_variant
        distros:
          - windows-2022-xxlarge

  - &enterprise-windows-all-feature-flags-required-template
    <<: *windows_compile_variant_dependency
    name: &enterprise-windows-all-feature-flags-required enterprise-windows-all-feature-flags-required
    display_name: "! Enterprise Windows Server 2022 (all feature flags)"
    tags: ["required"]
    cron: "0 */4 * * *" # From the ${project_required_suggested_cron} parameter
    run_on:
      - windows-2022-small
    expansions:
      <<: *windows_expansions
      burn_in_tests_build_variant: enterprise-windows-all-feature-flags-required
      exe: ".exe"
      content_type: application/zip
      python: "/cygdrive/c/python/python310/python.exe"
      ext: zip
      multiversion_platform: windows
      multiversion_edition: enterprise
      jstestfuzz_num_generated_files: 35
      target_resmoke_time: 20
      max_sub_suites: 5
      large_distro_name: windows-2022-large
      # To force disable feature flags even on the all feature flags variant, please use this file:
      # buildscripts/resmokeconfig/fully_disabled_feature_flags.yml
      test_flags: >-
        --runAllFeatureFlagTests
        --excludeWithAnyTags=incompatible_with_windows_tls
      external_auth_jobs_max: 1
      # Uncomment expansion and `burn_in_tasks_gen` task below and add resmoke task name to burn-in.
      # WARNING! Task splitting is not supported for burn-in tasks. Large unsplitted `_gen` tasks may
      # run too long and hit execution timeouts.
      # burn_in_task_name: jsCore
    tasks:
      # - name: burn_in_tasks_gen
      #   depends_on:
      #   - name: version_burn_in_gen
      #     variant: generate-tasks-for-version
      #     omit_generated_tasks: true
      #   - name: archive_dist_test_debug
      #     variant: *windows_compile_variant_name
      - name: .development_critical !.requires_large_host !.requires_compile_variant !.incompatible_development_variant !.incompatible_windows !.incompatible_all_feature_flags
      - name: .development_critical .requires_large_host !.requires_compile_variant !.incompatible_development_variant !.incompatible_windows !.incompatible_all_feature_flags
        distros:
          - windows-2022-large
      - name: .release_critical !.requires_large_host !.requires_compile_variant !.incompatible_development_variant !.incompatible_windows !.incompatible_all_feature_flags
      - name: .release_critical .requires_large_host !.requires_compile_variant !.incompatible_development_variant !.incompatible_windows !.incompatible_all_feature_flags
        distros:
          - windows-2022-large
