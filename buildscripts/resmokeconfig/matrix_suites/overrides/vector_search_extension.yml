# Overrides for $vectorSearch extension passthrough suites

# NOTE: Disabled feature flags are also marked with --disableFeatureFlags in tasks.yml to prevent
# --runAllFeatureFlagTests from overriding these values.

# Exclude tests that are incompatible with the extension-enabled configuration.
- name: exclude_incompatible_tests
  value:
    selector:
      exclude_files:
        # Risks leaving FCV stuck at 8.0, breaking all subsequent FCV-gated tests.
        # Extension is unsupported on FCV < 8.3.
        - jstests/with_mongot/e2e/views/mongot_indexed_views_upgrade_downgrade.js

        # Tests that fail due to unimplemented behavior in ~/mongot-extension.
        - jstests/with_mongot/e2e/hybridSearch/vector_search_remove_embeddings.js
        - jstests/with_mongot/e2e/skip_limit.js
        - jstests/with_mongot/e2e/views/search_with_view_injected.js

# Exclude tests that are incompatible with sharded extension-enabled configuration.
# This includes all exclusions from exclude_incompatible_tests plus sharded-only failures.
- name: exclude_sharded_incompatible_tests
  value:
    selector:
      exclude_files:
        # Risks leaving FCV stuck at 8.0, breaking all subsequent FCV-gated tests.
        # Extension is unsupported on FCV < 8.3.
        - jstests/with_mongot/e2e/views/mongot_indexed_views_upgrade_downgrade.js

        # Tests that fail due to unimplemented behavior in ~/mongot-extension.
        - jstests/with_mongot/e2e/hybridSearch/vector_search_remove_embeddings.js
        - jstests/with_mongot/e2e/skip_limit.js
        - jstests/with_mongot/e2e/views/search_with_view_injected.js

        # TODO SERVER-117794: Remove this exclusion.
        - jstests/with_mongot/e2e/views/mongot_stage_in_view_definition.js
        - jstests/with_mongot/e2e/views/vector_search/unionWith.js

- name: load_extension
  value:
    executor:
      fixture:
        mongod_options:
          loadExtensions: mongot-extension

- name: extension_enabled
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_disabled
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false

- name: load_extension_sharded
  value:
    executor:
      fixture:
        mongod_options:
          loadExtensions: mongot-extension

- name: extension_enabled_sharded
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_disabled_sharded
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_enabled_single_shard
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1

- name: extension_disabled_single_shard
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1

# Overrides for sharded cluster suites (mongot_e2e_sharded_cluster base).
# These include gRPC parameters needed for communication with mongot.
- name: extension_enabled_sharded_cluster
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1

- name: extension_disabled_sharded_cluster
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
