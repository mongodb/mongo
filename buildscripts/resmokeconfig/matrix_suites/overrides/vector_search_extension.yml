# Overrides for $vectorSearch extension passthrough suites

# NOTE: Disabled feature flags are also marked with --disableFeatureFlags in tasks.yml to prevent
# --runAllFeatureFlagTests from overriding these values.

# Exclude tests that are incompatible with the extension-enabled configuration.
- name: exclude_incompatible_tests
  value:
    selector:
      exclude_files:
        # Risks leaving FCV stuck at 8.0, breaking all subsequent FCV-gated tests.
        # Extension is unsupported on FCV < 8.3.
        - jstests/with_mongot/e2e/views/mongot_indexed_views_upgrade_downgrade.js
        # Tests that fail due to unimplemented behavior in ~/mongot-extension.
        - jstests/with_mongot/e2e/views/search_with_view_injected.js

- name: exclude_fully_enabled_incompatible_tests
  value:
    selector:
      exclude_files:
        # Risks leaving FCV stuck at 8.0, breaking all subsequent FCV-gated tests.
        # Extension is unsupported on FCV < 8.3.
        - jstests/with_mongot/e2e/views/mongot_indexed_views_upgrade_downgrade.js
        # Tests that fail due to unimplemented behavior in ~/mongot-extension.
        - jstests/with_mongot/e2e/views/search_with_view_injected.js

        # TODO SERVER-118709 Remove these exclusions.
        - jstests/with_mongot/e2e/views/vector_search/undefined_or_underlying_index.js
        - jstests/with_mongot/e2e/views/vector_search/addFields_base_case.js
        - jstests/with_mongot/e2e/views/vector_search/match_base_case.js
        - jstests/with_mongot/e2e/views/vector_search/unionWith.js
        - jstests/with_mongot/e2e/views/vector_search/unionWith_nested.js
        - jstests/with_mongot/e2e/views/vector_search/nested_view.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_on_search_view.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_on_search_view.js
        - jstests/with_mongot/e2e/views/mongot_stage_in_view_definition.js

- name: load_extension
  value:
    executor:
      fixture:
        mongod_options:
          loadExtensions: mongot-extension

- name: extension_enabled
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_fully_enabled
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: true

- name: extension_disabled
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false

- name: load_extension_sharded
  value:
    executor:
      fixture:
        mongos_options:
          loadExtensions: mongot-extension
        mongod_options:
          loadExtensions: mongot-extension

- name: extension_enabled_sharded
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_disabled_sharded
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_enabled_single_shard
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1

- name: extension_disabled_single_shard
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1

# Overrides for sharded cluster suites (mongot_e2e_sharded_cluster base).
# These include gRPC parameters needed for communication with mongot.
- name: extension_enabled_sharded_cluster
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1

- name: extension_fully_enabled_sharded
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: true
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: true
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1

- name: extension_disabled_sharded_cluster
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
            featureFlagEgressGrpcForSearch: true
            skipAuthenticationToMongot: true
            useGrpcForSearch: 1
