# Overrides for $vectorSearch extension passthrough suites

# NOTE: Disabled feature flags are also marked with --disableFeatureFlags in tasks.yml to prevent
# --runAllFeatureFlagTests from overriding these values.

# Exclude tests that are incompatible with the extension-enabled configuration.
- name: exclude_incompatible_tests
  value:
    selector:
      exclude_files:
        # Risks leaving FCV stuck at 8.0, breaking all subsequent FCV-gated tests.
        # Extension is unsupported on FCV < 8.3.
        - jstests/with_mongot/e2e/views/mongot_indexed_views_upgrade_downgrade.js

        # Tests that fail due to unimplemented behavior in ~/mongot-extension.
        - jstests/with_mongot/e2e/hybridSearch/vector_search_remove_embeddings.js
        - jstests/with_mongot/e2e/skip_limit.js
        - jstests/with_mongot/e2e/views/search_with_view_injected.js

        # TODO SERVER-117782: Remove these exclusions when IFR retry for $rankFusion and $scoreFusion is implemented.
        - jstests/with_mongot/e2e/hybridSearch/hybrid_search_weights_test.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_on_search_view.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_on_view.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_score_details_test.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_test.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_union_with.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_with_filter.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_failure_assertions.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_on_search_view.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_on_view.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_score_details_test.js
        - jstests/with_mongot/e2e/hybridSearch/score_multiple_stages.js

# Exclude tests that are incompatible with sharded extension-enabled configuration.
# This includes all exclusions from exclude_incompatible_tests plus sharded-only failures.
- name: exclude_sharded_incompatible_tests
  value:
    selector:
      exclude_files:
        # Risks leaving FCV stuck at 8.0, breaking all subsequent FCV-gated tests.
        # Extension is unsupported on FCV < 8.3.
        - jstests/with_mongot/e2e/views/mongot_indexed_views_upgrade_downgrade.js

        # Tests that fail due to unimplemented behavior in ~/mongot-extension.
        - jstests/with_mongot/e2e/hybridSearch/vector_search_remove_embeddings.js
        - jstests/with_mongot/e2e/skip_limit.js
        - jstests/with_mongot/e2e/views/search_with_view_injected.js

        # TODO SERVER-117782: Remove these exclusions when IFR retry for $rankFusion and $scoreFusion is implemented.
        - jstests/with_mongot/e2e/hybridSearch/hybrid_search_weights_test.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_on_search_view.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_on_view.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_score_details_test.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_test.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_union_with.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_with_filter.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_failure_assertions.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_on_search_view.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_on_view.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_score_details_test.js
        - jstests/with_mongot/e2e/hybridSearch/score_multiple_stages.js

        # TODO SERVER-118499: Remove this exclusion when sortKey is propogated correctly.
        - jstests/with_mongot/e2e/metadata/meta_dependency_validation.js
        - jstests/with_mongot/e2e/views/vector_search/unionWith.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_verbose_replace_root_test.js
        - jstests/with_mongot/e2e/hybridSearch/ranked_fusion_verbose_test.js
        - jstests/with_mongot/e2e/hybridSearch/score_fusion_verbose_test.js
        - jstests/with_mongot/e2e/hybridSearch/union_with_vector_search.js
        - jstests/with_mongot/e2e/metadata/searchScore_as_score_metadata.js
        - jstests/with_mongot/e2e/metadata/sort_by_vector_search_score.js

        # TODO SERVER-117794: Remove this exclusion.
        - jstests/with_mongot/e2e/views/mongot_stage_in_view_definition.js

- name: load_extension
  value:
    executor:
      fixture:
        mongod_options:
          loadExtensions: mongot-extension

- name: extension_enabled
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_disabled
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false

- name: load_extension_sharded
  value:
    executor:
      fixture:
        mongod_options:
          loadExtensions: mongot-extension

- name: extension_enabled_sharded
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: true
            featureFlagExtensionViewsAndUnionWith: false

- name: extension_disabled_sharded
  value:
    executor:
      fixture:
        mongod_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
        mongos_options:
          set_parameters:
            featureFlagExtensionsAPI: true
            featureFlagVectorSearchExtension: false
            featureFlagExtensionViewsAndUnionWith: false
