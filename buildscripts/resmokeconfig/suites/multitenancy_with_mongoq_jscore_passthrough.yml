test_kind: js_test
description: |
  Run test suites with a replica set and multitenancy enabled. Simulate the mongoq behavior
  by overriding and injecting signed security token.

selector:
  roots:
  - jstests/core/**/*.js
  - jstests/aggregation/**/*.js
  exclude_with_any_tags:
  # Exclude tests which use commands that aren't supported in Serverless.
  - command_not_supported_in_serverless
  # Exclude tests which we know use commands that don't support a security token.
  - not_allowed_with_security_token
  # Theses tests expect replication is not enabled.
  - assumes_standalone_mongod
  # capped collections are banned in Serverless.
  - requires_capped
  # startParallelShell creates a new connections with a different security token.
  - uses_parallel_shell
  # columnstore indexes are under development and cannot be used without enabling the feature flag
  - featureFlagColumnstoreIndexes
  # Server side javascript not allowed in Serverless.
  - requires_scripting
  exclude_files:
  # server-side javascript is not supported in serverless mode.
  - jstests/core/**/system_js_drop.js
  - jstests/core/**/system_js_access.js
  - jstests/core/**/where_system_js.js
  # setLogLevel calls setParameter command which is not allowed with security token.
  - jstests/core/**/list_all_local_sessions.js
  - jstests/core/**/list_all_sessions.js
  - jstests/core/txns/timestamped_reads_wait_for_prepare_oplog_visibility.js
  # cursor.close() calls killCursors command which is not allowed with security token.
  - jstests/core/**/list_collections1.js
  - jstests/core/**/list_indexes.js
  # collection.getPlanCache().* calls planCache* commands which are not allowed with security token.
  - jstests/core/**/cached_plan_trial_does_not_discard_work.js
  - jstests/core/**/collation_plan_cache.js
  - jstests/core/**/explode_for_sort_plan_cache.js
  - jstests/core/**/index_filter_commands.js
  - jstests/core/**/index_filter_commands_invalidate_plan_cache_entries.js
  - jstests/core/**/introspect_hidden_index_plan_cache_entries.js
  - jstests/core/**/neq_null_correctly_cache.js
  - jstests/core/**/operation_latency_histogram.js
  - jstests/core/**/plan_cache_list_plans.js
  - jstests/core/**/plan_cache_sbe.js
  - jstests/core/**/plan_cache_shell_helpers.js
  - jstests/core/**/plan_cache_stats_shard_and_host.js
  - jstests/core/**/profile_query_hash.js
  - jstests/core/sbe/from_plan_cache_flag.js
  - jstests/core/sbe/plan_cache_sbe_with_or_queries.js
  - jstests/core/sbe_plan_cache_autoparameterize_collscan.js
  - jstests/core/timeseries/bucket_unpacking_with_sort_plan_cache.js
  - jstests/core/**/wildcard_index_cached_plans.js
  # FixtureHelpers.getPrimaries() calls connectionStatus command which is not allowed with security token.
  - jstests/core/txns/transaction_too_large_for_cache.js
  # defaultPrompt() calls buildInfo command which is not allowed with security token.
  - jstests/core/txns/shell_prompt_in_transaction.js
  # Cannot test the user is not allowed to create indexes in config.transactions as the
  # inject_security_token.js runs command on tenant's config.transactions.
  - jstests/core/**/create_indexes.js
  # checkLog calls getLog command which is not allowed  with security token.
  - jstests/core/**/doc_validation_options.js
  # exhaust does not use runCommand (required by the inject_security_token.js override).
  - jstests/core/**/exhaust.js
  # This test does not use same connection on same database (required by the inject_security_token.js override).
  - jstests/core/txns/write_conflicts_with_non_txns.js
  # In a multitenancy environment the catalog will always return tenant-prefixed entries, and the
  # override we use in this suite checks for the absence of a prefix breaking the list_catalog tests.
  - jstests/core/**/list_catalog.js
  # This test uses '_hashBSONElement' command that cannot be run with security token.
  - jstests/core/**/index_key_expression.js
  # Queryable encryption test performs implicit encryption which issues commands that don't
  # include the security token.
  - jstests/core/queryable_encryption/**/*.js
  # These following tests use benchRun which does not use runCommand (required by the inject_security_token.js override).
  - jstests/core/**/bench_test1.js
  - jstests/core/**/bench_test2.js
  - jstests/core/**/benchrun_cmd_param_error.js
  - jstests/core/**/benchrun_pipeline_updates.js
  # TODO SERVER-81009: fix VTS missing from opCtx for distinct transactions
  - jstests/core/txns/view_reads_in_transaction.js
  # failed on: prefix check in response
  - jstests/aggregation/sources/documents.js
  - jstests/aggregation/sources/densify/internal_parse.js
  - jstests/aggregation/api_version_stage_allowance_checks.js
  # failed on: For index scan, total scannedObjects should be sum of
  # (total documents in local collection + total matched documents in foreign collection)
  - jstests/aggregation/sources/lookup/lookup_query_stats.js
  # not allowed with security token
  - jstests/aggregation/sources/setWindowFields/spill_to_disk.js
  - jstests/aggregation/bugs/hash_lookup_spill_large_and_small_documents_correctly.js
  - jstests/aggregation/query_limits_test.js
  - jstests/aggregation/sources/densify/densify_sort_opt_comparison.js
  - jstests/aggregation/sources/densify/memory_limit.js
  - jstests/aggregation/sources/lookup/lookup_single_solution_cache.js
  - jstests/aggregation/sources/setWindowFields/memory_limit.js
  - jstests/aggregation/bugs/server21632.js
  - jstests/aggregation/bugs/sbe_pushdown_replan_reason.js
  - jstests/aggregation/sources/unionWith/unionWith.js
  - jstests/aggregation/optimize_away_pipeline.js
  - jstests/aggregation/lookup_let_optimization.js
  - jstests/aggregation/sources/lookup/profile_lookup.js
  - jstests/aggregation/spill_to_disk.js
  - jstests/aggregation/sources/search_stage_error.js
  - jstests/aggregation/sources/densify/generated_limit.js
  - jstests/aggregation/group_conversion_to_distinct_scan.js
  - jstests/aggregation/is_count_like.js
  # runs scripting engine
  - jstests/aggregation/expressions/internal_js_emit_with_scope.js
  - jstests/aggregation/agg_infinite_recursion.js
  - jstests/aggregation/accumulators/accumulator_js_size_limits.js
  - jstests/aggregation/sources/unionWith/unionWith_maxTimeMS.js
  - jstests/aggregation/accumulators/internal_js_reduce_with_scope.js
  - jstests/aggregation/accumulators/internal_js_reduce.js
  - jstests/aggregation/expressions/expression_function.js
  - jstests/aggregation/accumulators/accumulator_js.js
  - jstests/aggregation/expressions/internal_js_emit.js

executor:
  archive:
    tests: true
    hooks:
      - CheckReplDBHash
      - CheckReplOplogs
      - ValidateCollections
  config:
    shell_options:
      eval: |
        globalThis.testingReplication = true;
        await import('jstests/libs/override_methods/inject_security_token.js');
      global_vars:
        TestData: &TestData
          hashTestNamesForMultitenancy: true
          testOnlyValidatedTenancyScopeKey: secret
  hooks:
  # The CheckReplDBHash hook waits until all operations have replicated to and have been applied
  # on the secondaries, so we run the ValidateCollections hook after it to ensure we're
  # validating the entire contents of the collection.
  - class: CheckReplOplogs
  - class: CheckReplDBHash
  - class: ValidateCollections
  - class: CleanEveryN
    n: 20
  fixture:
    class: ReplicaSetFixture
    num_nodes: 3
    mongod_options:
      set_parameters:
        enableTestCommands: 1
        multitenancySupport: true
        featureFlagSecurityToken: true
        testOnlyValidatedTenancyScopeKey: secret
        # The mongoq only works with a replica set which has featureFlagRequireTenantID enabled.
        featureFlagRequireTenantID: true
        logComponentVerbosity:
          command: 2
      noscripting: ''
