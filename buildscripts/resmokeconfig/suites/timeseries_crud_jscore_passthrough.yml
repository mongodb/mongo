test_kind: js_test

selector:
  roots:
    - jstests/core/query/**/*.js
    - jstests/core/write/**/*.js
  exclude_files:
    # The paths below are excluded from running in this suite because prior to moving under the
    # 'query' directory, they were not running in this suite.
    # TODO SERVER-94567 Determine if any of these tests can be enabled.
    - jstests/core/query/json_schema/**/*.js
    - jstests/core/query/doc_validation/**/*.js
    - jstests/core/query/api/**/*.js
    - jstests/core/query/queryable_encryption/**/*.js
    - jstests/core/query/sbe/**/*.js

    # Hashed indexes.
    - jstests/core/query/internal_hash_eq/**/*.js

    # Explain will return different plan than expected when a collection becomes a time-series
    # collection. Also, query shape will be different.
    - jstests/core/query/explain/**/*.js

    - jstests/core/query/elemmatch/**/*.js # $elemMatch

    # Time-series collections are views which don't support map-reduce
    - jstests/core/query/map_reduce/**/*.js

    - jstests/core/query/js/**/*.js
    - jstests/core/query/where/**/*.js
  exclude_with_any_tags:
    - requires_sharding
    - requires_capped
    - assumes_standalone_mongod
    - exclude_from_timeseries_crud_passthrough
executor:
  archive:
    hooks:
      - ValidateCollections
  config:
    shell_options:
      eval: globalThis.testingReplication = true;; await import("jstests/libs/override_methods/implicit_timeseries_collections.js");
      global_vars:
        TestData:
          isTimeseriesTestSuite: true
  hooks:
    # ValidateCollections may issue direct system.buckets commands, so run CheckSystemBucketsMetrics first.
    - class: CheckSystemBucketsMetrics
    - class: RunCanaryWorkloadInBackground
    - class: ValidateCollections
    - class: CleanEveryN
      n: 20
  fixture:
    class: ReplicaSetFixture
    mongod_options:
      set_parameters:
        enableTestCommands: 1
        featureFlagTimeseriesUpdatesSupport: true
        performTimeseriesCompressionIntermediateDataIntegrityCheckOnInsert: true
        performTimeseriesCompressionIntermediateDataIntegrityCheckOnInsertFrequency: 100
