/**
 * Test that mkcert.py generates certificates deterministically, and that pkcs12 certificates, while
 * not deterministic, can be generated. Uses the libs/x509/apple_certs.json and main_certs.json
 * files, which are static copies of the JSON files generated by the x509:generate_main_certificates
 * and x509:generate_apple_certificates bazel targets.
 */

import {getPython3Binary} from "jstests/libs/python.js";

const now = new Date();
// Note - month is 0-indexed, so 11 is December.
if (now.getMonth() == 11 && now.getDate() == 31 && now.getHours() == 23) {
    jsTest.log.warning(
        "Deterministic certificate generation relies on the current year being constant; skipping test as there is less than an hour until the year changes.",
    );
    quit();
}

// Print the openssl version to help with debugging.
clearRawMongoProgramOutput();
assert.eq(runNonMongoProgram("openssl", "version"), 0);
jsTest.log.info(rawMongoProgramOutput(".*"));

const main_cert_json_file = "jstests/noPassthrough/libs/x509/main_certs.json";
const apple_cert_json_file = "jstests/noPassthrough/libs/x509/apple_certs.json";
const basedir = MongoRunner.dataPath + "certs/";
const genpath = basedir + "generated/";
mkdir(genpath);

// Run mkcert, and ensure it succeeds and that expected results are generated successfully.
jsTest.log.info("Running mkcert");
clearRawMongoProgramOutput();
let res = runNonMongoProgram(getPython3Binary(), "x509/mkcert.py", main_cert_json_file, "--mkcrl", "-o", genpath);
jsTest.log.info(rawMongoProgramOutput(".*"));
assert.eq(res, 0);
assert(fileExists(genpath + "ca.pem"));
assert(fileExists(genpath + "crl.pem"));

// Run mkcert again, to a different path.
const genpath2 = basedir + "generated2/";
mkdir(genpath2);
jsTest.log.info("Running mkcert again");
res = runNonMongoProgram(getPython3Binary(), "x509/mkcert.py", main_cert_json_file, "--mkcrl", "-o", genpath2);
assert.eq(res, 0);

// Diff the two generation paths to make sure the contents of the paths are identical.
jsTest.log.info("Running diff");
clearRawMongoProgramOutput();
res = runNonMongoProgram("diff", "-r", genpath, genpath2);
assert.eq(res, 0);
const diffout = rawMongoProgramOutput(".*").trim();
assert.eq("", diffout, diffout);

// Run mkcert on the apple cert definitions file, which contains pkcs12 certificates, and
// ensure a .pfx file was generated.
jsTest.log.info("Running apple certs");
res = runNonMongoProgram(getPython3Binary(), "x509/mkcert.py", apple_cert_json_file, "-o", genpath);
assert.eq(res, 0);
assert(fileExists(genpath + "macos-trusted-server.pfx"));
