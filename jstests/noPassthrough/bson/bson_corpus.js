/**
 * Simple read-write exercise of our bson corpus.
 *
 * @tags: [
 * requires_external_data_source,
 * ]
 */

// Runs tests on a standalone mongod.
let conn = MongoRunner.runMongod({setParameter: {enableComputeMode: true}});
let db = conn.getDB(jsTestName());

////////////////////////////////////////////////////////////////////////////////////////////////
// Test handling of some bson edge cases by attempting insert and fetch with content
// generated by src/mongo/bson/util:bson_corpus_gen and checking that it correctly reads back.
////////////////////////////////////////////////////////////////////////////////////////////////
(function testBSONCorpus() {
    jsTestLog("Testing testBSONCorpus()");

    // Verify the objects read from the pipes match what was written to them.
    let numExpectedResults = globalThis._numObjsInCorpus();
    for (let objIdx = 0; objIdx < numExpectedResults; ++objIdx) {
        jsTestLog("Running " + objIdx);
        let obj = globalThis._getObjInCorpus(objIdx);
        assert.commandWorked(db.test.insert(obj));
        assert.eq(db.test.findOne({_id: obj._id}), obj);
    }
})();

MongoRunner.stopMongod(conn);
