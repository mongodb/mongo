functions:
  "setup go env":
    command: shell.exec
    params:
      working_dir: src
      script: |
        set -o verbose
        export GOPATH=`pwd`
        ${preproc_gpm|echo} ./gpm
        ./gpm install

  "generate coverage html + text":
    command: shell.exec
    params:
      working_dir: src
      script: |
        set -o verbose
        export GOPATH=`pwd`
        if [ '${coverage|false}' = 'true' ]
        then
            go tool cover -html=coverage.out -o coverage.html
            go tool cover -func=coverage.out -o coverage.txt
        fi

  "upload coverage report":
    command: s3.put
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      local_file: src/coverage.${format|txt}
      remote_file: mci-tools/coverage/${task_id}.${format|txt}
      bucket: mciuploads
      permissions: public-read
      content_type: ${content_type|text/plain}
      build_variants: ["ubuntu"]

  "attach coverage reports" :
    command: attach.task_files
    params:
      "Coverage Report (HTML)": https://s3.amazonaws.com/mciuploads/mci-tools/coverage/${task_id}.html
      "Coverage Report (TXT)": https://s3.amazonaws.com/mciuploads/mci-tools/coverage/${task_id}.txt

  "download mongod":
    command: shell.exec
    params:
      script: |
        set -o errexit
        rm -rf mongodb
        mkdir mongodb
        cd mongodb
        curl -s ${mongo_url} --output mongodb.tgz
        ${decompress} mongodb.tgz
        mv ./mongodb-*/* .

  "start mongod":
    command: shell.exec
    params:
      script: |
        set -o errexit
        rm -rf mongodb/${db_files_dir|db_files}
        rm -f mongodb/${logfile|run.log}
        mkdir mongodb/${db_files_dir|db_files}
        ./mongodb/bin/mongod --dbpath ./mongodb/${db_files_dir|db_files} --logpath ./mongodb/${logfile|run.log} --port ${port|27017} --fork ${mongod_extra_options|}

  "kill mongod":
    command: shell.exec
    params:
      script: |
        pkill -9 mongod;

  "run tests":
    command: shell.exec
    params:
      working_dir: src
      script: |
        set -o verbose
        export GOPATH=`pwd`
        cd src/github.com/shelman/mongo-tools-proto/${package}
        go test -i
        if [ '${coverage|false}' = 'true' ]
        then
            go test -v -test.types=${types} -coverprofile=coverage.out
            mv coverage.out $GOPATH
        else
            go test -v -test.types=${types} 
        fi

  "run unit tests":
    command: gotest.run
    params:
      working_dir: src
      tests:
        - dir: src/github.com/shelman/mongo-tools-proto/common/${package}
          args: ${coverage_args}

  "move coverage data":
    command: shell.exec
    params:
      working_dir: src
      script: |
        set -o verbose
        mv src/github.com/shelman/mongo-tools-proto/common/${package}/coverage.out $GOPATH

pre:
  - command: expansions.fetch
    params:
      keys:
        - local_key: "aws_key"
          remote_key: "project_aws_key"
        - local_key: "aws_secret"
          remote_key: "project_aws_secret"

post:
  - func: "kill mongod"

tasks:

- name: bsonutil
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - command: expansions.update
      params:
        updates:
          - key: "package"
            value: "bsonutil"
    - func: "run unit tests"
    - func: "move coverage data"
    - func: "generate coverage html + text"
    - func: "upload coverage report"
    - func: "upload coverage report"
      vars:
        format: "html"
        content_type: "text/html"
    - func: "attach coverage reports"

- name: db
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - func: "download mongod"
    - func: "start mongod"
    - func: "run tests"
      vars:
        package: "common/db"
        types: "db"
    - func: "generate coverage html + text"
    - func: "upload coverage report"
    - func: "upload coverage report"
      vars:
        format: "html"
        content_type: "text/html"
    - func: "attach coverage reports"

- name: json
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - command: expansions.update
      params:
        updates:
          - key: "package"
            value: "json"
    - func: "run unit tests"
    - func: "move coverage data"
    - func: "generate coverage html + text"
    - func: "upload coverage report"
    - func: "upload coverage report"
      vars:
        format: "html"
        content_type: "text/html"
    - func: "attach coverage reports"

- name: log
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - command: expansions.update
      params:
        updates:
          - key: "package"
            value: "log"
    - func: "run unit tests"
    - func: "move coverage data"
    - func: "generate coverage html + text"
    - func: "upload coverage report"
    - func: "upload coverage report"
      vars:
        format: "html"
        content_type: "text/html"
    - func: "attach coverage reports"

- name: lint
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -o verbose
          export GOPATH=`pwd`
          go run src/github.com/3rf/mongo-lint/golint/golint.go src/github.com/shelman/mongo-tools-proto

- name: vet
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -o verbose
          export GOPATH=`pwd`
          go tool vet src/github.com/shelman/mongo-tools-proto/

- name: util
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - func: "run tests"
      vars:
        package: "common/util"
        types: "unit"
    - func: "generate coverage html + text"
    - func: "upload coverage report"
    - func: "upload coverage report"
      vars:
        format: "html"
        content_type: "text/html"
    - func: "attach coverage reports"

- name: ssl
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - func: "download mongod"
    - command: expansions.update
      params:
        updates:
          - key: "package"
            value: "common/db/ssl"
          - key: "types"
            value: "ssl"
          - key: "port"
            value: "20000"
    - func: "start mongod"
    - func: "run tests"
    - func: "kill mongod"
    - command: expansions.update
      params:
        updates:
          - key: "types"
            value: "ssl_auth"
          - key: "mongod_extra_options"
            value: "--sslMode requireSSL --sslCAFile src/src/github.com/shelman/mongo-tools-proto/common/db/ssl/testdata/ca.pem --sslPEMKeyFile src/src/github.com/shelman/mongo-tools-proto/common/db/ssl/testdata/server.pem --auth"
    - func: "start mongod"
    - func: "run tests"

- name: auth
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "setup go env"
    - func: "download mongod"
    - func: "start mongod"
    - func: "run tests"
      vars:
        package: "common/db"
        types: "auth"
    - func: "generate coverage html + text"
    - func: "upload coverage report"
    - func: "upload coverage report"
      vars:
        format: "html"
        content_type: "text/html"
    - func: "attach coverage reports"

buildvariants:

- name: ubuntu
  display_name: Ubuntu
  run_on:
  - ubuntu1404-test
  expansions:
    mongo_url: http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.6.4.tgz
    coverage: 'true'
    coverage_args: "-coverprofile=coverage.out"
  tasks:
  - name: bsonutil
  - name: db
  - name: json
  - name: log
  - name: util

- name: ubuntu-ssl
  display_name: Ubuntu SSL
  run_on:
  - ubuntu1404-test
  expansions:
    mongo_url: http://downloads.10gen.com/linux/mongodb-linux-x86_64-enterprise-ubuntu1404-latest.tgz
    mongod_extra_options: --sslMode requireSSL --sslCAFile src/src/github.com/shelman/mongo-tools-proto/common/db/ssl/testdata/ca.pem --sslPEMKeyFile src/src/github.com/shelman/mongo-tools-proto/common/db/ssl/testdata/server.pem
  tasks:
  - name: ssl

- name: ubuntu-auth
  display_name: Ubuntu Auth
  run_on:
  - ubuntu1404-test
  expansions:
    mongo_url: http://downloads.10gen.com/linux/mongodb-linux-x86_64-enterprise-ubuntu1404-latest.tgz
    mongod_extra_options: --auth
  tasks:
  - name: auth

- name: osx-108
  display_name: OSX 10.8
  run_on:
  - osx-108
  expansions:
    mongo_url: https://fastdl.mongodb.org/osx/mongodb-osx-x86_64-2.6.4.tgz
    coverage_args: "-coverprofile=coverage.out"
  tasks:
  - name: bsonutil
  - name: db
  - name: json
  - name: log
  - name: util

- name: solaris
  display_name: Solaris
  run_on:
  - solaris
  expansions:
    mongo_url: https://fastdl.mongodb.org/sunos5/mongodb-sunos5-x86_64-2.6.4.tgz
  tasks:
  - name: db
  - name: util

- name: windows-64
  display_name: Windows-64
  run_on:
  - windows-64-vs2013-test
  expansions:
    mongo_url: https://fastdl.mongodb.org/win32/mongodb-win32-x86_64-2008plus-2.6.4.zip
    preproc_gpm: "perl -pi -e 's/\\r\\n/\\n/g' "
  tasks:
  - name: db
  - name: util
