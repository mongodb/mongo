# -*- mode: python -*-

Import("env")

env = env.Clone()

env.Library(
    target="sharding_mongod_test_fixture",
    source=[
        "sharding_mongod_test_fixture.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/repl/drop_pending_collection_reaper",
        "$BUILD_DIR/mongo/db/repl/replmocks",
        "$BUILD_DIR/mongo/db/repl/storage_interface_impl",
        "$BUILD_DIR/mongo/db/service_context_d_test_fixture",
        "$BUILD_DIR/mongo/s/sharding_test_fixture_common",
        "sharding_runtime_d",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/db/op_observer/op_observer",
        "$BUILD_DIR/mongo/db/op_observer/op_observer_impl",
        "$BUILD_DIR/mongo/db/op_observer/operation_logger_impl",
        "$BUILD_DIR/mongo/db/session/session_catalog_mongod",
    ],
)

env.Library(
    target="shard_server_test_fixture",
    source=[
        "shard_server_test_fixture.cpp",
    ],
    LIBDEPS=[
        "sharding_mongod_test_fixture",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/s/catalog/sharding_catalog_client_impl",
    ],
)

env.Library(
    target="config_server_test_fixture",
    source=[
        "config/config_server_test_fixture.cpp",
    ],
    LIBDEPS=[
        "sharding_mongod_test_fixture",
    ],
    LIBDEPS_PRIVATE=[
        "$BUILD_DIR/mongo/db/op_observer/op_observer",
        "$BUILD_DIR/mongo/db/op_observer/op_observer_impl",
        "$BUILD_DIR/mongo/db/op_observer/operation_logger_impl",
        "$BUILD_DIR/mongo/s/catalog/sharding_catalog_client_impl",
    ],
)

env.CppUnitTest(
    target="shard_server_op_observer_test",
    source=[
        "shard_server_op_observer_test.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/op_observer/op_observer_util",
        "$BUILD_DIR/mongo/db/repl/replmocks",
        "$BUILD_DIR/mongo/db/repl/storage_interface_impl",
        "$BUILD_DIR/mongo/db/service_context_d_test_fixture",
        "sharding_runtime_d",
    ],
)

env.CppUnitTest(
    target="db_s_shard_server_test",
    source=[
        "active_migrations_registry_test.cpp",
        "analyze_shard_key_read_write_distribution_test.cpp",
        "auto_split_vector_test.cpp",
        "balancer/balance_stats_test.cpp",
        "collection_metadata_filtering_test.cpp",
        "collection_metadata_test.cpp",
        "collection_sharding_runtime_test.cpp",
        "database_sharding_state_test.cpp",
        "ddl_lock_manager_test.cpp",
        "implicit_collection_creation_test.cpp",
        "metadata_consistency_util_test.cpp",
        "metadata_manager_test.cpp",
        "metrics/phase_duration_test.cpp",
        "metrics/sharding_data_transform_cumulative_metrics_test.cpp",
        "metrics/sharding_data_transform_instance_metrics_test.cpp",
        "migration_batch_fetcher_test.cpp",
        "migration_blocking_operation/migration_blocking_operation_coordinator_test.cpp",
        "migration_blocking_operation/multi_update_coordinator_test.cpp",
        "migration_chunk_cloner_source_test.cpp",
        "migration_destination_manager_test.cpp",
        "migration_session_id_test.cpp",
        "migration_util_test.cpp",
        "namespace_metadata_change_notifications_test.cpp",
        "op_observer_sharding_test.cpp",
        "operation_sharding_state_test.cpp",
        "primary_only_service_helpers/cancel_state_test.cpp",
        "persistent_task_queue_test.cpp",
        "query_analysis_writer_test.cpp",
        "range_arithmetic_test.cpp",
        "range_deleter_service_op_observer_test.cpp",
        "range_deleter_service_test.cpp",
        "range_deleter_service_test_util.cpp",
        "range_deletion_util_test.cpp",
        "resharding/resharding_agg_test.cpp",
        "resharding/resharding_collection_cloner_test.cpp",
        "resharding/resharding_collection_test.cpp",
        "resharding/resharding_cumulative_metrics_test.cpp",
        "resharding/resharding_data_replication_test.cpp",
        "resharding/resharding_destined_recipient_test.cpp",
        "resharding/resharding_donor_oplog_iterator_test.cpp",
        "resharding/resharding_donor_recipient_common_test.cpp",
        "resharding/resharding_donor_service_test.cpp",
        "resharding/resharding_future_util_test.cpp",
        "resharding/resharding_metrics_test.cpp",
        "resharding/resharding_oplog_applier_metrics_test.cpp",
        "resharding/resharding_oplog_applier_test.cpp",
        "resharding/resharding_oplog_batch_applier_test.cpp",
        "resharding/resharding_oplog_batch_preparer_test.cpp",
        "resharding/resharding_oplog_crud_application_test.cpp",
        "resharding/resharding_oplog_fetcher_test.cpp",
        "resharding/resharding_oplog_session_application_test.cpp",
        "resharding/resharding_recipient_service_external_state_test.cpp",
        "resharding/resharding_recipient_service_test.cpp",
        "resharding/resharding_txn_cloner_test.cpp",
        "session_catalog_migration_destination_test.cpp",
        "session_catalog_migration_source_test.cpp",
        "shard_key_index_util_test.cpp",
        "shard_local_test.cpp",
        "shard_metadata_util_test.cpp",
        "shard_server_catalog_cache_loader_test.cpp",
        "sharding_ddl_coordinator_external_state_for_test.cpp",
        "sharding_ddl_coordinator_service_test.cpp",
        "sharding_ddl_coordinator_test.cpp",
        "sharding_initialization_mongod_test.cpp",
        "sharding_initialization_op_observer_test.cpp",
        "sharding_logging_test.cpp",
        "sharding_recovery_service_test.cpp",
        "split_chunk_request_test.cpp",
        "split_vector_test.cpp",
        "start_chunk_clone_request_test.cpp",
        "transaction_coordinator_catalog_test.cpp",
        "transaction_coordinator_futures_util_test.cpp",
        "transaction_coordinator_service_test.cpp",
        "transaction_coordinator_structures_test.cpp",
        "transaction_coordinator_test.cpp",
        "transaction_coordinator_test_fixture.cpp",
        "type_shard_collection_test.cpp",
        "type_shard_identity_test.cpp",
        "vector_clock_shard_server_test.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/client/remote_command_targeter_mock",
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/catalog/catalog_helpers",
        "$BUILD_DIR/mongo/db/catalog/catalog_test_fixture",
        "$BUILD_DIR/mongo/db/coll_mod_command_idl",
        "$BUILD_DIR/mongo/db/commands/create_command",
        "$BUILD_DIR/mongo/db/commands/list_collections_filter",
        "$BUILD_DIR/mongo/db/exec/document_value/document_value_test_util",
        "$BUILD_DIR/mongo/db/index_builds_coordinator_mock",
        "$BUILD_DIR/mongo/db/index_commands_idl",
        "$BUILD_DIR/mongo/db/keys_collection_client_direct",
        "$BUILD_DIR/mongo/db/op_observer/op_observer",
        "$BUILD_DIR/mongo/db/op_observer/op_observer_impl",
        "$BUILD_DIR/mongo/db/op_observer/op_observer_util",
        "$BUILD_DIR/mongo/db/op_observer/operation_logger_impl",
        "$BUILD_DIR/mongo/db/pipeline/document_source_mock",
        "$BUILD_DIR/mongo/db/pipeline/process_interface/shardsvr_process_interface",
        "$BUILD_DIR/mongo/db/query/query_request",
        "$BUILD_DIR/mongo/db/query/query_test_service_context",
        "$BUILD_DIR/mongo/db/query/write_ops/write_ops_exec",
        "$BUILD_DIR/mongo/db/query_expressions",
        "$BUILD_DIR/mongo/db/read_write_concern_defaults_mock",
        "$BUILD_DIR/mongo/db/repl/image_collection_entry",
        "$BUILD_DIR/mongo/db/repl/mock_repl_coord_server_fixture",
        "$BUILD_DIR/mongo/db/repl/oplog_application",
        "$BUILD_DIR/mongo/db/repl/oplog_interface_local",
        "$BUILD_DIR/mongo/db/repl/primary_only_service_test_fixture",
        "$BUILD_DIR/mongo/db/repl/replmocks",
        "$BUILD_DIR/mongo/db/repl/storage_interface_impl",
        "$BUILD_DIR/mongo/db/session/logical_session_cache_impl",
        "$BUILD_DIR/mongo/db/session/session_catalog_mongod",
        "$BUILD_DIR/mongo/db/timeseries/timeseries_options",
        "$BUILD_DIR/mongo/executor/thread_pool_task_executor_test_fixture",
        "$BUILD_DIR/mongo/s/catalog/sharding_catalog_client_mock",
        "$BUILD_DIR/mongo/s/sharding_mongos_test_fixture",
        "analyze_shard_key_util",
        "query_analysis_writer",
        "shard_server_test_fixture",
        "sharding_catalog",
        "sharding_commands_d",
        "sharding_logging",
        "transaction_coordinator",
    ],
)

env.CppUnitTest(
    target="db_s_config_server_test",
    source=[
        "balancer/auto_merger_policy_test.cpp",
        "balancer/balancer_chunk_selection_policy_test.cpp",
        "balancer/balancer_defragmentation_policy_test.cpp",
        "balancer/move_unsharded_policy_test.cpp",
        "balancer/balancer_policy_test.cpp",
        "balancer/balancer_commands_scheduler_test.cpp",
        "balancer/migration_test_fixture.cpp",
        "config_server_op_observer_test.cpp",
        "config/configsvr_coordinator_service_test.cpp",
        "config/index_on_config_test.cpp",
        "config/initial_split_policy_test.cpp",
        "config/sharding_catalog_manager_add_shard_test.cpp",
        "config/sharding_catalog_manager_add_shard_to_zone_test.cpp",
        "config/sharding_catalog_manager_assign_key_range_to_zone_test.cpp",
        "config/sharding_catalog_manager_bump_collection_version_and_change_metadata_test.cpp",
        "config/sharding_catalog_manager_clear_jumbo_flag_test.cpp",
        "config/sharding_catalog_manager_commit_chunk_migration_test.cpp",
        "config/sharding_catalog_manager_config_initialization_test.cpp",
        "config/sharding_catalog_manager_configure_collection_balancing_test.cpp",
        "config/sharding_catalog_manager_database_operations_test.cpp",
        "config/sharding_catalog_manager_ensure_chunk_version_is_greater_than_test.cpp",
        "config/sharding_catalog_manager_merge_chunks_test.cpp",
        "config/sharding_catalog_manager_remove_shard_from_zone_test.cpp",
        "config/sharding_catalog_manager_remove_shard_test.cpp",
        "config/sharding_catalog_manager_shard_collection_test.cpp",
        "config/sharding_catalog_manager_split_chunk_test.cpp",
        "config/set_cluster_parameter_coordinator_test.cpp",
        "query_analysis_coordinator_test.cpp",
        "resharding/resharding_coordinator_commit_monitor_test.cpp",
        "resharding/resharding_coordinator_observer_test.cpp",
        "resharding/resharding_coordinator_test.cpp",
        "resharding/resharding_coordinator_service_test.cpp",
        "resharding/resharding_util_test.cpp",
        "sharding_catalog_client_aggregations_test.cpp",
        "sharding_ddl_util_test.cpp",
        "sharding_util_refresh_test.cpp",
        "topology_time_ticker_test.cpp",
        "vector_clock_config_server_test.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/collection_crud/collection_crud",
        "$BUILD_DIR/mongo/db/commands/cluster_server_parameter_commands_invocation",
        "$BUILD_DIR/mongo/db/commands/set_feature_compatibility_version_idl",
        "$BUILD_DIR/mongo/db/multitenancy",
        "$BUILD_DIR/mongo/db/op_observer/op_observer",
        "$BUILD_DIR/mongo/db/pipeline/document_source_mock",
        "$BUILD_DIR/mongo/db/read_write_concern_defaults_mock",
        "$BUILD_DIR/mongo/db/repl/primary_only_service",
        "$BUILD_DIR/mongo/db/repl/primary_only_service_test_fixture",
        "$BUILD_DIR/mongo/db/repl/replication_info",
        "$BUILD_DIR/mongo/db/repl/storage_interface_impl",
        "$BUILD_DIR/mongo/db/repl/wait_for_majority_service",
        "$BUILD_DIR/mongo/db/session/session_catalog_mongod",
        "$BUILD_DIR/mongo/db/timeseries/timeseries_options",
        "$BUILD_DIR/mongo/db/transaction/transaction",
        "$BUILD_DIR/mongo/db/transaction/transaction_api",
        "$BUILD_DIR/mongo/idl/cluster_server_parameter_common",
        "$BUILD_DIR/mongo/util/version_impl",
        "config_server_test_fixture",
        "sharding_commands_d",
    ],
)

env.Benchmark(
    target="chunk_manager_refresh_bm",
    source=[
        "chunk_manager_refresh_bm.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/shard_role_api",
    ],
    CONSOLIDATED_TARGET="sharding_bm",
)

env.Benchmark(
    target="migration_chunk_cloner_source_bm",
    source=[
        "migration_chunk_cloner_source_bm.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/auth/authorization_manager_global",
        "sharding_runtime_d",
    ],
)

env.Benchmark(
    target="sharding_write_router_bm",
    source=[
        "sharding_write_router_bm.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/auth/authorization_manager_global",
        "$BUILD_DIR/mongo/db/service_context_non_d",
        "$BUILD_DIR/mongo/s/catalog/sharding_catalog_client_impl",
        "$BUILD_DIR/mongo/s/sharding_test_fixture_common",
        "sharding_runtime_d",
    ],
    CONSOLIDATED_TARGET="sharding_bm",
)

env.Benchmark(
    target="placement_history_bm",
    source=[
        "placement_history_bm.cpp",
    ],
    LIBDEPS=[
        "$BUILD_DIR/mongo/db/auth/authmocks",
        "$BUILD_DIR/mongo/db/auth/authorization_manager_global",
        "$BUILD_DIR/mongo/db/read_write_concern_defaults_mock",
        "$BUILD_DIR/mongo/db/repl/wait_for_majority_service",
        "$BUILD_DIR/mongo/db/session/session_catalog_mongod",
        "config_server_test_fixture",
        "sharding_catalog_manager",
    ],
)
