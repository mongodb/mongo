# BUILD.bazel for vendored libxml2

package(default_visibility = ["//visibility:public"])

licenses(["notice"])  # MIT License

# Platform-specific include directories for generated headers
LIBXML2_PLATFORM_COPTS = select({
    "@platforms//cpu:aarch64": [
        "-Iexternal/libxml2/platform/linux_aarch64/include",
    ],
    "@platforms//cpu:x86_64": [
        "-Iexternal/libxml2/platform/linux_x86_64/include",
    ],
    "@platforms//cpu:s390x": [
        "-Iexternal/libxml2/platform/linux_s390x/include",
    ],
    "@platforms//cpu:ppc": [
        "-Iexternal/libxml2/platform/linux_ppc64le/include",
    ],
    "//conditions:default": [],
})

# Common compiler options
LIBXML2_COMMON_COPTS = [
    "-Wno-error",
    "-Wno-unused-parameter",
    "-Wno-missing-field-initializers",
    "-Wno-implicit-fallthrough",
]

cc_library(
    name = "libxml2",
    srcs = glob(
        [
            "*.c",
        ],
        exclude = [
            # Test/example files
            "test*.c",
            "run*.c",
            # Command-line tools (contain main() functions)
            "xmllint.c",
            "lintmain.c",
            "xmlcatalog.c",
            # Platform-specific files we don't need
            "trio*.c",
        ],
    ),
    hdrs = glob([
        "include/libxml/*.h",
        "include/private/*.h",
        "codegen/*.inc",
        "*.h",
    ]) + select({
        "@platforms//cpu:aarch64": glob([
            "platform/linux_aarch64/include/*.h",
            "platform/linux_aarch64/include/libxml/*.h",
        ]),
        "@platforms//cpu:x86_64": glob([
            "platform/linux_x86_64/include/*.h",
            "platform/linux_x86_64/include/libxml/*.h",
        ]),
        "@platforms//cpu:s390x": glob([
            "platform/linux_s390x/include/*.h",
            "platform/linux_s390x/include/libxml/*.h",
        ]),
        "@platforms//cpu:ppc": glob([
            "platform/linux_ppc64le/include/*.h",
            "platform/linux_ppc64le/include/libxml/*.h",
        ]),
        "//conditions:default": [],
    }),
    copts = LIBXML2_COMMON_COPTS + LIBXML2_PLATFORM_COPTS + [
        "-Iexternal/libxml2/include",
        "-Iexternal/libxml2",
    ],
    includes = [
        "include",
    ] + select({
        "@platforms//cpu:aarch64": [
            "platform/linux_aarch64/include",
        ],
        "@platforms//cpu:x86_64": [
            "platform/linux_x86_64/include",
        ],
        "@platforms//cpu:s390x": [
            "platform/linux_s390x/include",
        ],
        "@platforms//cpu:ppc": [
            "platform/linux_ppc64le/include",
        ],
        "//conditions:default": [],
    }),
    linkopts = select({
        "@platforms//os:linux": [
            "-lpthread",
            "-ldl",
        ],
        "//conditions:default": [],
    }),
    local_defines = [
        "HAVE_CONFIG_H",
        "_REENTRANT",
    ],
    target_compatible_with = select({
        "@platforms//os:linux": [],
        "//conditions:default": ["@platforms//:incompatible"],
    }),
)
