load("//bazel:mongo_src_rules.bzl", "mongo_cc_library")

package(default_visibility = ["//visibility:public"])

# On windows and macos we don't have this problem, but on other
# platforms we do, where the system libgcc may duplicate symbols that
# exist in the intel library. We use a version script to force our
# version of the symbols into a version namespace that we control,
# avoiding the conflict. It also allows us to restrict the set of
# visible symbols in the library to just those used in
# platform/decimal128.cpp. We still use an exported_symbol_list on
# macOS too though, so that we can catch the case where we have a
# symbolic dependency on a symbol that isn't exported. We will catch
# that on macOS, whereas we might not on libgcc platforms where we
# could end up binding to the shadow version.
exports_files([
    "libintel_decimal128.exported_symbols_list.lds",
    "libintel_decimal128.version_script.lds",
])

INTEL_RDFP_MATHLIB_DEFINES = [
    "DECIMAL_CALL_BY_REFERENCE=0",
    "DECIMAL_GLOBAL_ROUNDING=0",
    "DECIMAL_GLOBAL_EXCEPTION_FLAGS=0",
    "UNCHANGED_BINARY_STATUS_FLAGS=0",
    "USE_COMPILER_F128_TYPE=0",
    "USE_COMPILER_F80_TYPE=0",
    "USE_NATIVE_QUAD_TYPE=0",
] + select({
    "@platforms//os:linux": [
        "LINUX=1",
        "linux=1",
    ],
    "@platforms//os:macos": [
        "LINUX=1",
        "mach=1",
    ],
    "//conditions:default": [],
}) + select({
    "@platforms//cpu:s390x": [
        "s390x=1",
        "BID_BIG_ENDIAN=1",
    ],
    "//conditions:default": [
        "efi2=1",
        "EFI2=1",
    ],
}) + select({
    "//bazel/config:compiler_type_msvc": [
        "cl=1",
    ],
    "//conditions:default": [
        "gcc=1",
    ],
}) + select({
    "@platforms//os:windows": [
        "WINDOWS",
        "WNT",
        "winnt",
    ],
    "//conditions:default": [],
})

IGNORE_WARNINGS_COPT = select({
    "@platforms//os:windows": [
        "/W0",

        # C4273: '...': inconsistent dll linkage
        "/wd4273",

        # C4477: incorrect scanf format string
        "/wd4477",
    ],
    "//conditions:default": ["-w"],
})

DYNAMIC_LOOKUP_LINKOPT = select({
    "@platforms//os:macos": ["-Wl,-undefined,dynamic_lookup"],
    "//conditions:default": [""],
})

INTEL_RDFP_FLOAT128_INTERNAL_HEADERS = [
    "LIBRARY/float128/architecture.h",
    "LIBRARY/float128/assert.h",
    "LIBRARY/float128/build.h",
    "LIBRARY/float128/compiler.h",
    "LIBRARY/float128/dpml_acosh_t.h",
    "LIBRARY/float128/dpml_asinh_t.h",
    "LIBRARY/float128/dpml_bessel_x.h",
    "LIBRARY/float128/dpml_bid_x.h",
    "LIBRARY/float128/dpml_cbrt_x.h",
    "LIBRARY/float128/dpml_cons_x.h",
    "LIBRARY/float128/dpml_erf_t.h",
    "LIBRARY/float128/dpml_erf_x.h",
    "LIBRARY/float128/dpml_error_codes.h",
    "LIBRARY/float128/dpml_error_codes_enum.h",
    "LIBRARY/float128/dpml_exception.h",
    "LIBRARY/float128/dpml_exp_x.h",
    "LIBRARY/float128/dpml_function_info.h",
    "LIBRARY/float128/dpml_globals.h",
    "LIBRARY/float128/dpml_int_x.h",
    "LIBRARY/float128/dpml_inv_hyper_x.h",
    "LIBRARY/float128/dpml_inv_trig_x.h",
    "LIBRARY/float128/dpml_lgamma_t.h",
    "LIBRARY/float128/dpml_lgamma_x.h",
    "LIBRARY/float128/dpml_log2_t.h",
    "LIBRARY/float128/dpml_log_t.h",
    "LIBRARY/float128/dpml_log_x.h",
    "LIBRARY/float128/dpml_mod_x.h",
    "LIBRARY/float128/dpml_names.h",
    "LIBRARY/float128/dpml_pow.h",
    "LIBRARY/float128/dpml_pow_x.h",
    "LIBRARY/float128/dpml_powi_x.h",
    "LIBRARY/float128/dpml_private.h",
    "LIBRARY/float128/dpml_rdx_x.h",
    "LIBRARY/float128/dpml_special_exp.h",
    "LIBRARY/float128/dpml_sqrt_x.h",
    "LIBRARY/float128/dpml_trig_x.h",
    "LIBRARY/float128/dpml_ux.h",
    "LIBRARY/float128/dpml_ux_32_64.h",
    "LIBRARY/float128/dpml_ux_alpha_macros.h",
    "LIBRARY/float128/endian.h",
    "LIBRARY/float128/f_format.h",
    "LIBRARY/float128/i_format.h",
    "LIBRARY/float128/ix86_macros.h",
    "LIBRARY/float128/mphoc_functions.h",
    "LIBRARY/float128/mphoc_macros.h",
    "LIBRARY/float128/mtc_macros.h",
    "LIBRARY/float128/op_system.h",
    "LIBRARY/float128/poly_macros.h",
    "LIBRARY/float128/sqrt_macros.h",
]

mongo_cc_library(
    name = "dpml_log1p_t",
    srcs = [
        "LIBRARY/float128/dpml_log.c",
    ] + INTEL_RDFP_FLOAT128_INTERNAL_HEADERS,
    copts = IGNORE_WARNINGS_COPT,
    linkopts = DYNAMIC_LOOKUP_LINKOPT,
    local_defines = INTEL_RDFP_MATHLIB_DEFINES + [
        "LOG1P=1",
        "efi2=1",
        "EFI2=1",
        "T_FLOAT",
    ],
)

mongo_cc_library(
    name = "intel_decimal128",
    srcs = [
        "LIBRARY/float128/dpml_exception.c",
        "LIBRARY/float128/dpml_four_over_pi.c",
        "LIBRARY/float128/dpml_ux_bessel.c",
        "LIBRARY/float128/dpml_ux_bid.c",
        "LIBRARY/float128/dpml_ux_cbrt.c",
        "LIBRARY/float128/dpml_ux_erf.c",
        "LIBRARY/float128/dpml_ux_exp.c",
        "LIBRARY/float128/dpml_ux_int.c",
        "LIBRARY/float128/dpml_ux_inv_hyper.c",
        "LIBRARY/float128/dpml_ux_inv_trig.c",
        "LIBRARY/float128/dpml_ux_lgamma.c",
        "LIBRARY/float128/dpml_ux_log.c",
        "LIBRARY/float128/dpml_ux_mod.c",
        "LIBRARY/float128/dpml_ux_ops.c",
        "LIBRARY/float128/dpml_ux_ops_64.c",
        "LIBRARY/float128/dpml_ux_pow.c",
        "LIBRARY/float128/dpml_ux_powi.c",
        "LIBRARY/float128/dpml_ux_sqrt.c",
        "LIBRARY/float128/dpml_ux_trig.c",
        "LIBRARY/float128/sqrt_tab_t.c",
        "LIBRARY/src/bid128.c",
        "LIBRARY/src/bid128_2_str_tables.c",
        "LIBRARY/src/bid128_acos.c",
        "LIBRARY/src/bid128_acosh.c",
        "LIBRARY/src/bid128_add.c",
        "LIBRARY/src/bid128_asin.c",
        "LIBRARY/src/bid128_asinh.c",
        "LIBRARY/src/bid128_atan.c",
        "LIBRARY/src/bid128_atan2.c",
        "LIBRARY/src/bid128_atanh.c",
        "LIBRARY/src/bid128_cbrt.c",
        "LIBRARY/src/bid128_compare.c",
        "LIBRARY/src/bid128_cos.c",
        "LIBRARY/src/bid128_cosh.c",
        "LIBRARY/src/bid128_div.c",
        "LIBRARY/src/bid128_erf.c",
        "LIBRARY/src/bid128_erfc.c",
        "LIBRARY/src/bid128_exp.c",
        "LIBRARY/src/bid128_exp10.c",
        "LIBRARY/src/bid128_exp2.c",
        "LIBRARY/src/bid128_expm1.c",
        "LIBRARY/src/bid128_fdimd.c",
        "LIBRARY/src/bid128_fma.c",
        "LIBRARY/src/bid128_fmod.c",
        "LIBRARY/src/bid128_frexp.c",
        "LIBRARY/src/bid128_hypot.c",
        "LIBRARY/src/bid128_ldexp.c",
        "LIBRARY/src/bid128_lgamma.c",
        "LIBRARY/src/bid128_llrintd.c",
        "LIBRARY/src/bid128_log.c",
        "LIBRARY/src/bid128_log10.c",
        "LIBRARY/src/bid128_log1p.c",
        "LIBRARY/src/bid128_log2.c",
        "LIBRARY/src/bid128_logb.c",
        "LIBRARY/src/bid128_logbd.c",
        "LIBRARY/src/bid128_lrintd.c",
        "LIBRARY/src/bid128_lround.c",
        "LIBRARY/src/bid128_minmax.c",
        "LIBRARY/src/bid128_modf.c",
        "LIBRARY/src/bid128_mul.c",
        "LIBRARY/src/bid128_nearbyintd.c",
        "LIBRARY/src/bid128_next.c",
        "LIBRARY/src/bid128_nexttowardd.c",
        "LIBRARY/src/bid128_noncomp.c",
        "LIBRARY/src/bid128_pow.c",
        "LIBRARY/src/bid128_quantexpd.c",
        "LIBRARY/src/bid128_quantize.c",
        "LIBRARY/src/bid128_rem.c",
        "LIBRARY/src/bid128_round_integral.c",
        "LIBRARY/src/bid128_scalb.c",
        "LIBRARY/src/bid128_scalbl.c",
        "LIBRARY/src/bid128_sin.c",
        "LIBRARY/src/bid128_sinh.c",
        "LIBRARY/src/bid128_sqrt.c",
        "LIBRARY/src/bid128_string.c",
        "LIBRARY/src/bid128_tan.c",
        "LIBRARY/src/bid128_tanh.c",
        "LIBRARY/src/bid128_tgamma.c",
        "LIBRARY/src/bid128_to_int16.c",
        "LIBRARY/src/bid128_to_int32.c",
        "LIBRARY/src/bid128_to_int64.c",
        "LIBRARY/src/bid128_to_int8.c",
        "LIBRARY/src/bid128_to_uint16.c",
        "LIBRARY/src/bid128_to_uint32.c",
        "LIBRARY/src/bid128_to_uint64.c",
        "LIBRARY/src/bid128_to_uint8.c",
        "LIBRARY/src/bid32_acos.c",
        "LIBRARY/src/bid32_acosh.c",
        "LIBRARY/src/bid32_add.c",
        "LIBRARY/src/bid32_asin.c",
        "LIBRARY/src/bid32_asinh.c",
        "LIBRARY/src/bid32_atan.c",
        "LIBRARY/src/bid32_atan2.c",
        "LIBRARY/src/bid32_atanh.c",
        "LIBRARY/src/bid32_cbrt.c",
        "LIBRARY/src/bid32_compare.c",
        "LIBRARY/src/bid32_cos.c",
        "LIBRARY/src/bid32_cosh.c",
        "LIBRARY/src/bid32_div.c",
        "LIBRARY/src/bid32_erf.c",
        "LIBRARY/src/bid32_erfc.c",
        "LIBRARY/src/bid32_exp.c",
        "LIBRARY/src/bid32_exp10.c",
        "LIBRARY/src/bid32_exp2.c",
        "LIBRARY/src/bid32_expm1.c",
        "LIBRARY/src/bid32_fdimd.c",
        "LIBRARY/src/bid32_fma.c",
        "LIBRARY/src/bid32_fmod.c",
        "LIBRARY/src/bid32_frexp.c",
        "LIBRARY/src/bid32_hypot.c",
        "LIBRARY/src/bid32_ldexp.c",
        "LIBRARY/src/bid32_lgamma.c",
        "LIBRARY/src/bid32_llrintd.c",
        "LIBRARY/src/bid32_log.c",
        "LIBRARY/src/bid32_log10.c",
        "LIBRARY/src/bid32_log1p.c",
        "LIBRARY/src/bid32_log2.c",
        "LIBRARY/src/bid32_logb.c",
        "LIBRARY/src/bid32_logbd.c",
        "LIBRARY/src/bid32_lrintd.c",
        "LIBRARY/src/bid32_lround.c",
        "LIBRARY/src/bid32_minmax.c",
        "LIBRARY/src/bid32_modf.c",
        "LIBRARY/src/bid32_mul.c",
        "LIBRARY/src/bid32_nearbyintd.c",
        "LIBRARY/src/bid32_next.c",
        "LIBRARY/src/bid32_nexttowardd.c",
        "LIBRARY/src/bid32_noncomp.c",
        "LIBRARY/src/bid32_pow.c",
        "LIBRARY/src/bid32_quantexpd.c",
        "LIBRARY/src/bid32_quantize.c",
        "LIBRARY/src/bid32_rem.c",
        "LIBRARY/src/bid32_round_integral.c",
        "LIBRARY/src/bid32_scalb.c",
        "LIBRARY/src/bid32_scalbl.c",
        "LIBRARY/src/bid32_sin.c",
        "LIBRARY/src/bid32_sinh.c",
        "LIBRARY/src/bid32_sqrt.c",
        "LIBRARY/src/bid32_string.c",
        "LIBRARY/src/bid32_sub.c",
        "LIBRARY/src/bid32_tan.c",
        "LIBRARY/src/bid32_tanh.c",
        "LIBRARY/src/bid32_tgamma.c",
        "LIBRARY/src/bid32_to_bid128.c",
        "LIBRARY/src/bid32_to_bid64.c",
        "LIBRARY/src/bid32_to_int16.c",
        "LIBRARY/src/bid32_to_int32.c",
        "LIBRARY/src/bid32_to_int64.c",
        "LIBRARY/src/bid32_to_int8.c",
        "LIBRARY/src/bid32_to_uint16.c",
        "LIBRARY/src/bid32_to_uint32.c",
        "LIBRARY/src/bid32_to_uint64.c",
        "LIBRARY/src/bid32_to_uint8.c",
        "LIBRARY/src/bid64_acos.c",
        "LIBRARY/src/bid64_acosh.c",
        "LIBRARY/src/bid64_add.c",
        "LIBRARY/src/bid64_asin.c",
        "LIBRARY/src/bid64_asinh.c",
        "LIBRARY/src/bid64_atan.c",
        "LIBRARY/src/bid64_atan2.c",
        "LIBRARY/src/bid64_atanh.c",
        "LIBRARY/src/bid64_cbrt.c",
        "LIBRARY/src/bid64_compare.c",
        "LIBRARY/src/bid64_cos.c",
        "LIBRARY/src/bid64_cosh.c",
        "LIBRARY/src/bid64_div.c",
        "LIBRARY/src/bid64_erf.c",
        "LIBRARY/src/bid64_erfc.c",
        "LIBRARY/src/bid64_exp.c",
        "LIBRARY/src/bid64_exp10.c",
        "LIBRARY/src/bid64_exp2.c",
        "LIBRARY/src/bid64_expm1.c",
        "LIBRARY/src/bid64_fdimd.c",
        "LIBRARY/src/bid64_fma.c",
        "LIBRARY/src/bid64_fmod.c",
        "LIBRARY/src/bid64_frexp.c",
        "LIBRARY/src/bid64_hypot.c",
        "LIBRARY/src/bid64_ldexp.c",
        "LIBRARY/src/bid64_lgamma.c",
        "LIBRARY/src/bid64_llrintd.c",
        "LIBRARY/src/bid64_log.c",
        "LIBRARY/src/bid64_log10.c",
        "LIBRARY/src/bid64_log1p.c",
        "LIBRARY/src/bid64_log2.c",
        "LIBRARY/src/bid64_logb.c",
        "LIBRARY/src/bid64_logbd.c",
        "LIBRARY/src/bid64_lrintd.c",
        "LIBRARY/src/bid64_lround.c",
        "LIBRARY/src/bid64_minmax.c",
        "LIBRARY/src/bid64_modf.c",
        "LIBRARY/src/bid64_mul.c",
        "LIBRARY/src/bid64_nearbyintd.c",
        "LIBRARY/src/bid64_next.c",
        "LIBRARY/src/bid64_nexttowardd.c",
        "LIBRARY/src/bid64_noncomp.c",
        "LIBRARY/src/bid64_pow.c",
        "LIBRARY/src/bid64_quantexpd.c",
        "LIBRARY/src/bid64_quantize.c",
        "LIBRARY/src/bid64_rem.c",
        "LIBRARY/src/bid64_round_integral.c",
        "LIBRARY/src/bid64_scalb.c",
        "LIBRARY/src/bid64_scalbl.c",
        "LIBRARY/src/bid64_sin.c",
        "LIBRARY/src/bid64_sinh.c",
        "LIBRARY/src/bid64_sqrt.c",
        "LIBRARY/src/bid64_string.c",
        "LIBRARY/src/bid64_tan.c",
        "LIBRARY/src/bid64_tanh.c",
        "LIBRARY/src/bid64_tgamma.c",
        "LIBRARY/src/bid64_to_bid128.c",
        "LIBRARY/src/bid64_to_int16.c",
        "LIBRARY/src/bid64_to_int32.c",
        "LIBRARY/src/bid64_to_int64.c",
        "LIBRARY/src/bid64_to_int8.c",
        "LIBRARY/src/bid64_to_uint16.c",
        "LIBRARY/src/bid64_to_uint32.c",
        "LIBRARY/src/bid64_to_uint64.c",
        "LIBRARY/src/bid64_to_uint8.c",
        "LIBRARY/src/bid_binarydecimal.c",
        "LIBRARY/src/bid_convert_data.c",
        "LIBRARY/src/bid_decimal_data.c",
        "LIBRARY/src/bid_decimal_globals.c",
        "LIBRARY/src/bid_dpd.c",
        "LIBRARY/src/bid_feclearexcept.c",
        "LIBRARY/src/bid_fegetexceptflag.c",
        "LIBRARY/src/bid_feraiseexcept.c",
        "LIBRARY/src/bid_fesetexceptflag.c",
        "LIBRARY/src/bid_fetestexcept.c",
        "LIBRARY/src/bid_flag_operations.c",
        "LIBRARY/src/bid_from_int.c",
        "LIBRARY/src/bid_round.c",
        "LIBRARY/src/strtod128.c",
        "LIBRARY/src/strtod32.c",
        "LIBRARY/src/strtod64.c",
        "LIBRARY/src/wcstod128.c",
        "LIBRARY/src/wcstod32.c",
        "LIBRARY/src/wcstod64.c",
    ] + INTEL_RDFP_FLOAT128_INTERNAL_HEADERS,
    hdrs = [
        "LIBRARY/src/bid128_2_str.h",
        "LIBRARY/src/bid128_2_str_macros.h",
        "LIBRARY/src/bid_b2d.h",
        "LIBRARY/src/bid_conf.h",
        "LIBRARY/src/bid_div_macros.h",
        "LIBRARY/src/bid_functions.h",
        "LIBRARY/src/bid_gcc_intrinsics.h",
        "LIBRARY/src/bid_inline_add.h",
        "LIBRARY/src/bid_internal.h",
        "LIBRARY/src/bid_sqrt_macros.h",
        "LIBRARY/src/bid_strtod.h",
        "LIBRARY/src/bid_trans.h",
        "LIBRARY/src/bid_wrap_names.h",
        "LIBRARY/src/dfp754.h",
    ] + [
        # Textually included c source files
        "LIBRARY/float128/dpml_ux_radian_reduce.c",
        "LIBRARY/float128/dpml_four_over_pi.c",
    ],
    additional_linker_inputs = select({
        "@platforms//os:linux": [
            ":libintel_decimal128.version_script.lds",
        ],
        "//conditions:default": [],
    }) + select({
        "@platforms//os:macos": [
            ":libintel_decimal128.exported_symbols_list.lds",
        ],
        "//conditions:default": [],
    }),
    copts = IGNORE_WARNINGS_COPT,
    includes = [
        "LIBRARY/src",
    ],
    local_defines = INTEL_RDFP_MATHLIB_DEFINES,
    non_transitive_dyn_linkopts = select({
        "@platforms//os:linux": [
            "-Wl,--version-script=$(location :libintel_decimal128.version_script.lds)",
        ],
        "//conditions:default": [],
    }) + select({
        "@platforms//os:macos": [
            "-Wl,-exported_symbols_list,$(location :libintel_decimal128.exported_symbols_list.lds)",
        ],
        "//conditions:default": [],
    }),
    deps = select({
        "@platforms//os:macos": [
            ":dpml_log1p_t",
        ],
        "//conditions:default": [],
    }),
)
