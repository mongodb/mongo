load("//bazel:mongo_src_rules.bzl", "mongo_cc_library")

package(default_visibility = ["//visibility:public"])

mongo_cc_library(
    name = "gtest",
    srcs = glob(
        include = [
            "dist/googletest/src/*.cc",
            "dist/googletest/src/*.h",
            "dist/googletest/include/gtest/**/*.h",
            "dist/googlemock/src/*.cc",
            "dist/googlemock/include/gmock/**/*.h",
        ],
        exclude = [
            "dist/googletest/src/gtest-all.cc",
            "dist/googletest/src/gtest_main.cc",
            "dist/googlemock/src/gmock-all.cc",
            "dist/googlemock/src/gmock_main.cc",
        ],
    ),
    hdrs = glob([
        "dist/googletest/include/gtest/*.h",
        "dist/googlemock/include/gmock/*.h",
    ]),
    copts = select({
        "@platforms//os:windows": [],
        "//conditions:default": ["-pthread"],
    }),
    defines = [
        "GTEST_HAS_ABSL=1",
        "GTEST_NO_ABSL_FLAGS=1",
        "GTEST_DONT_DEFINE_FAIL=1",
    ],
    features = select({
        "@platforms//os:windows": ["windows_export_all_symbols"],
        "//conditions:default": [],
    }),
    includes = [
        "dist/googlemock",
        "dist/googlemock/include",
        "dist/googletest",
        "dist/googletest/include",
    ],
    linkopts = select({
        "@platforms//os:windows": [],
        "//conditions:default": ["-pthread"],
    }),
    deps = [
        "//src/third_party/re2",
        "@com_google_absl//absl/debugging:failure_signal_handler",
        "@com_google_absl//absl/flags:parse",
        "@com_google_absl//absl/types:any",
    ],
)
